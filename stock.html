<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Stok - Brew & Beats</title> <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... STYLE LAMA KAMU (TETAP SAMA) ... */
        body { background-color: #19194d; color: white; font-family: 'Montserrat', sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #a4a4e0; text-align: center; }
        .btn-back { display: inline-block; text-decoration: none; color: white; background: #333; padding: 8px 15px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9rem; cursor: pointer; border: none; }
        .btn-back:hover { background: #555; }
        .admin-form { background: #24245e; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #a4a4e0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; background: #15153a; border: 1px solid #a4a4e0; color: white; border-radius: 5px; box-sizing: border-box; }
        button { cursor: pointer; padding: 10px 20px; border-radius: 5px; border: none; font-weight: bold; }
        .btn-save { background: #a4a4e0; color: #19194d; width: 100%; }
        .menu-list { display: flex; flex-direction: column; gap: 10px; }
        .menu-item-card { background: #24245e; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #a4a4e0; }
        .menu-info h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .stock-info { color: #4ade80; font-weight: bold; font-size: 0.9rem; }
        .out-of-stock { color: #ff4d4d; }
        .actions { display: flex; gap: 10px; }
        .btn-edit { background: #FFC107; color: black; }
        .btn-delete { background: #FF4D4D; color: white; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="window.location.href='admin.html'">⬅ Kembali ke Dashboard</button>
    
    <h1>Manajemen Menu & Stok</h1>

    <div class="admin-form">
        <h3 id="form-title">Tambah Menu Baru</h3>
        <input type="hidden" id="menu-id">
        <div class="form-group">
            <label>Nama Menu</label>
            <input type="text" id="name" placeholder="Contoh: Americano">
        </div>
        <div class="form-group">
            <label>Harga (Angka saja)</label>
            <input type="number" id="price" placeholder="Contoh: 15000">
        </div>
        <div class="form-group">
            <label>Stok Awal</label>
            <input type="number" id="stock" placeholder="Contoh: 50" value="10">
        </div>
        <div class="form-group">
            <label>Kategori</label>
            <select id="category">
                <option value="DRINKS">DRINKS</option>
                <option value="TREATS">TREATS</option>
            </select>
        </div>
        <div class="form-group">
            <label>Deskripsi (Opsional)</label>
            <input type="text" id="desc" placeholder="Contoh: Best Seller">
        </div>
        <div class="form-group">
            <label>Bisa Kustom? (Add-ons)</label>
            <select id="supportsAddons">
                <option value="true">Ya (Untuk Minuman)</option>
                <option value="false">Tidak (Untuk Makanan)</option>
            </select>
        </div>
        <button class="btn-save" onclick="saveMenu()">SIMPAN MENU</button>
        <button onclick="resetForm()" style="background: transparent; color: #aaa; width: 100%; margin-top: 10px;">Batal / Reset</button>
    </div>

    <h3>Daftar Menu & Stok</h3>
    <div id="menu-list" class="menu-list">
        <p>Memuat data...</p>
    </div>
</div>

<script type="module">
    // 1. IMPORT FIREBASE LENGKAP
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCU82AX-l80wXvxb_S4eToRQ0cRt8RXZa4",
        authDomain: "brew-and-beats-5fbf2.firebaseapp.com",
        databaseURL: "https://brew-and-beats-5fbf2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "brew-and-beats-5fbf2",
        storageBucket: "brew-and-beats-5fbf2.firebasestorage.app",
        messagingSenderId: "243138026852",
        appId: "1:243138026852:web:73d5e7cdb446949033ee71",
        measurementId: "G-S3ZX1F1FTP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app); 

    // --- 2. CEK LOGIN (SECURITY) ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            loadMenuData();
        } else {
            alert("⚠️ Anda harus login dulu!");
            window.location.href = 'index.html';
        }
    });

    // --- 3. LOAD MENU ---
    const menuRef = ref(db, 'menu');
    const menuList = document.getElementById('menu-list');

    function loadMenuData() {
        onValue(menuRef, (snapshot) => {
            menuList.innerHTML = '<p class="text-gray-400">Memuat data...</p>';
            const data = snapshot.val();
            
            if (!data) {
                menuList.innerHTML = '<p class="text-gray-400">Belum ada menu.</p>';
                return;
            }

            menuList.innerHTML = '';
            Object.keys(data).forEach(key => {
                const item = data[key];
                const soldOutClass = item.isSoldOut ? 'opacity-50 grayscale' : '';
                const statusText = item.isSoldOut ? '<span style="color:#ff4d4d; font-weight:bold;">(HABIS)</span>' : '<span style="color:#4ade80; font-weight:bold;">(ADA)</span>';
                
                // Format Rupiah
                const priceFormatted = parseInt(item.price).toLocaleString('id-ID');

                // Gunakan class sesuai CSS di <head> tadi (menu-item-card) agar rapi
                const row = `
                        <div class="menu-item-card ${soldOutClass}" style="margin-bottom:10px;">
                            <div class="menu-info">
                                <h3>${item.name} ${statusText}</h3>
                                <div style="font-size:0.85rem; opacity:0.8;">${item.category} | Stok: ${item.stock}</div>
                                <div style="font-weight:bold; margin-top:5px;">Rp ${priceFormatted}</div>
                            </div>
                            <div class="actions">
                                <button onclick="editMenu('${key}')" style="background-color: #3b82f6; color: white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-right:5px;">
                                    Edit
                                </button>
                                
                                <button onclick="toggleSoldOut('${key}', ${item.isSoldOut})" style="background-color: ${item.isSoldOut ? '#4ade80' : '#FFC107'}; color: #000; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">
                                    ${item.isSoldOut ? 'Set Ada' : 'Set Habis'}
                                </button>
                                <button onclick="deleteMenu('${key}')" class="btn-delete" style="padding:5px 10px; border-radius:5px; border:none; cursor:pointer; background-color: #ef4444; color: white;">
                                    Hapus
                                </button>
                            </div>
                        </div>
                    `;
                menuList.innerHTML += row;
            });
        });
    }

    // --- 4. FUNGSI SIMPAN MENU (SUDAH DIPERBAIKI ID-NYA) ---
    window.saveMenu = function() {
        // Ambil ID Rahasia
        const id = document.getElementById('menu-id').value;
        
        const name = document.getElementById('name').value;
        const price = document.getElementById('price').value;
        const stock = document.getElementById('stock').value;
        const category = document.getElementById('category').value;
        const desc = document.getElementById('desc').value;
        const supportsAddons = document.getElementById('supportsAddons').value === 'true';

        if (!name || !price || !stock) {
            alert("Mohon lengkapi Nama, Harga, dan Stok!");
            return;
        }

        const menuData = {
            name: name,
            price: parseInt(price),
            stock: parseInt(stock),
            category: category,
            desc: desc,
            supportsAddons: supportsAddons
        };

        if (id) {
            // --- SKENARIO 1: UPDATE (JIKA ID ADA) ---
            // Kita pakai 'update', bukan 'push'
            update(ref(db, 'menu/' + id), menuData)
            .then(() => {
                alert("✅ Stok/Data Berhasil Diupdate!");
                resetForm(); // Bersihkan form
            })
            .catch((error) => alert("Gagal update: " + error.message));
        } else {
            // --- SKENARIO 2: BARU (JIKA ID KOSONG) ---
            menuData.isSoldOut = false; // Default status
            push(menuRef, menuData)
            .then(() => {
                alert("✅ Menu Baru Ditambahkan!");
                resetForm();
            })
            .catch((error) => alert("Gagal simpan: " + error.message));
        }
    }

    // --- 5. FUNGSI RESET FORM ---
    window.resetForm = function() {
        document.getElementById('name').value = '';
        document.getElementById('price').value = '';
        document.getElementById('stock').value = '10';
        document.getElementById('desc').value = '';
        document.getElementById('menu-id').value = ''; 
        document.getElementById('form-title').innerText = 'Tambah Menu Baru';
    }

    // --- 6. FUNGSI ACTION LAINNYA ---
    window.deleteMenu = function(id) {
        if(confirm("Hapus menu ini permanen?")) {
            remove(ref(db, 'menu/' + id));
        }
    }

    window.toggleSoldOut = function(id, currentStatus) {
        update(ref(db, 'menu/' + id), {
            isSoldOut: !currentStatus
        });
    }
    // --- FUNGSI BARU: EDIT MENU ---
    window.editMenu = function(id) {
        // Ambil data dari database berdasarkan ID
        const itemRef = ref(db, 'menu/' + id);
        onValue(itemRef, (snapshot) => {
            const data = snapshot.val();
            if(data) {
                // Isi formulir dengan data yang mau diedit
                document.getElementById('menu-id').value = id; // Isi ID rahasia
                document.getElementById('name').value = data.name;
                document.getElementById('price').value = data.price;
                document.getElementById('stock').value = data.stock;
                document.getElementById('category').value = data.category;
                document.getElementById('desc').value = data.desc || '';
                document.getElementById('supportsAddons').value = data.supportsAddons.toString();
                
                // Ubah judul form biar jelas
                document.getElementById('form-title').innerText = "Edit Menu: " + data.name;
                window.scrollTo(0,0); // Scroll ke atas
            }
        }, {
            onlyOnce: true // Ambil sekali saja
        });
    }
</script>
</body>
</html>