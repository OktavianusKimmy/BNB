<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Stok - Brew & Beats</title> <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... STYLE LAMA KAMU (TETAP SAMA) ... */
        body { background-color: #19194d; color: white; font-family: 'Montserrat', sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #a4a4e0; text-align: center; }
        .btn-back { display: inline-block; text-decoration: none; color: white; background: #333; padding: 8px 15px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9rem; cursor: pointer; border: none; }
        .btn-back:hover { background: #555; }
        .admin-form { background: #24245e; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #a4a4e0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; background: #15153a; border: 1px solid #a4a4e0; color: white; border-radius: 5px; box-sizing: border-box; }
        button { cursor: pointer; padding: 10px 20px; border-radius: 5px; border: none; font-weight: bold; }
        .btn-save { background: #a4a4e0; color: #19194d; width: 100%; }
        .menu-list { display: flex; flex-direction: column; gap: 10px; }
        .menu-item-card { background: #24245e; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #a4a4e0; }
        .menu-info h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .stock-info { color: #4ade80; font-weight: bold; font-size: 0.9rem; }
        .out-of-stock { color: #ff4d4d; }
        .actions { display: flex; gap: 10px; }
        .btn-edit { background: #FFC107; color: black; }
        .btn-delete { background: #FF4D4D; color: white; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="window.location.href='admin.html'">⬅ Kembali ke Dashboard</button>
    
    <h1>Manajemen Menu & Stok</h1>

    <div class="admin-form">
        <h3 id="form-title">Tambah Menu Baru</h3>
        <input type="hidden" id="menu-id">
        <div class="form-group">
            <label>Nama Menu</label>
            <input type="text" id="name" placeholder="Contoh: Americano">
        </div>
        <div class="form-group">
            <label>Harga (Angka saja)</label>
            <input type="number" id="price" placeholder="Contoh: 15000">
        </div>
        <div class="form-group">
            <label>Stok Awal</label>
            <input type="number" id="stock" placeholder="Contoh: 50" value="10">
        </div>
        <div class="form-group">
            <label>Kategori</label>
            <select id="category">
                <option value="DRINKS">DRINKS</option>
                <option value="TREATS">TREATS</option>
            </select>
        </div>
        <div class="form-group">
            <label>Deskripsi (Opsional)</label>
            <input type="text" id="desc" placeholder="Contoh: Best Seller">
        </div>
        <div class="form-group">
            <label>Bisa Kustom? (Add-ons)</label>
            <select id="supportsAddons">
                <option value="true">Ya (Untuk Minuman)</option>
                <option value="false">Tidak (Untuk Makanan)</option>
            </select>
        </div>
        <button class="btn-save" onclick="saveMenu()">SIMPAN MENU</button>
        <button onclick="resetForm()" style="background: transparent; color: #aaa; width: 100%; margin-top: 10px;">Batal / Reset</button>
    </div>

    <h3>Daftar Menu & Stok</h3>
    <div id="menu-list" class="menu-list">
        <p>Memuat data...</p>
    </div>
</div>

<script type="module">
    // 1. IMPORT FIREBASE LENGKAP (DATABASE + AUTH)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCU82AX-l80wXvxb_S4eToRQ0cRt8RXZa4",
        authDomain: "brew-and-beats-5fbf2.firebaseapp.com",
        databaseURL: "https://brew-and-beats-5fbf2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "brew-and-beats-5fbf2",
        storageBucket: "brew-and-beats-5fbf2.firebasestorage.app",
        messagingSenderId: "243138026852",
        appId: "1:243138026852:web:73d5e7cdb446949033ee71",
        measurementId: "G-S3ZX1F1FTP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app); // Inisialisasi Auth

    // --- 2. CEK APAKAH USER LOGIN? (SECURITY CHECK) ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Aman, user adalah admin. Load data menu.
            loadMenuData();
        } else {
            // Tidak dikenal, tendang ke login
            alert("⚠️ Anda harus login dulu!");
            window.location.href = 'index.html';
        }
    });

    // --- 3. LOGIKA CRUD MENU (SEPERTI BIASA) ---
    const menuRef = ref(db, 'menu');
    const menuList = document.getElementById('menu-list');

    function loadMenuData() {
        onValue(menuRef, (snapshot) => {
            menuList.innerHTML = '<p class="text-gray-400">Memuat data...</p>';
            const data = snapshot.val();
            
            if (!data) {
                menuList.innerHTML = '<p class="text-gray-400">Belum ada menu.</p>';
                return;
            }

            menuList.innerHTML = '';
            Object.keys(data).forEach(key => {
                const item = data[key];
                const soldOutClass = item.isSoldOut ? 'opacity-50 grayscale' : '';
                const statusText = item.isSoldOut ? '<span class="text-red-500 font-bold">(HABIS)</span>' : '<span class="text-green-400 font-bold">(ADA)</span>';

                const row = `
                    <div class="bg-gray-800 p-4 rounded-lg flex justify-between items-center mb-2 ${soldOutClass}">
                        <div>
                            <h4 class="font-bold text-lg text-purple-300">${item.name} ${statusText}</h4>
                            <p class="text-sm text-gray-400">${item.category} | Stok: ${item.stock}</p>
                            <p class="text-sm font-bold">Rp ${parseInt(item.price).toLocaleString('id-ID')}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleSoldOut('${key}', ${item.isSoldOut})" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700">
                                ${item.isSoldOut ? 'Set Ada' : 'Set Habis'}
                            </button>
                            <button onclick="deleteMenu('${key}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                Hapus
                            </button>
                        </div>
                    </div>
                `;
                menuList.innerHTML += row;
            });
        });
    }

    // --- FUNGSI TAMBAH MENU ---
    // Tempel ke window agar bisa dipanggil tombol HTML
    window.saveMenu = function() {
        const name = document.getElementById('menu-name').value;
        const price = document.getElementById('menu-price').value;
        const stock = document.getElementById('menu-stock').value;
        const category = document.getElementById('menu-category').value;
        const desc = document.getElementById('menu-desc').value;
        const supportsAddons = document.getElementById('menu-addons').value === 'true';

        if (!name || !price || !stock) {
            alert("Mohon lengkapi Nama, Harga, dan Stok!");
            return;
        }

        // PUSH KE FIREBASE (Sekarang aman karena sudah Auth)
        push(menuRef, {
            name: name,
            price: parseInt(price),
            stock: parseInt(stock),
            category: category,
            desc: desc,
            supportsAddons: supportsAddons,
            isSoldOut: false
        }).then(() => {
            alert("✅ Menu Berhasil Ditambahkan!");
            // Reset Form
            document.getElementById('menu-name').value = '';
            document.getElementById('menu-price').value = '';
            document.getElementById('menu-stock').value = '10';
            document.getElementById('menu-desc').value = '';
        }).catch((error) => {
            console.error(error);
            alert("Gagal menyimpan: " + error.message);
        });
    }

    // --- FUNGSI DELETE & UPDATE STATUS ---
    window.deleteMenu = function(id) {
        if(confirm("Hapus menu ini permanen?")) {
            remove(ref(db, 'menu/' + id));
        }
    }

    window.toggleSoldOut = function(id, currentStatus) {
        update(ref(db, 'menu/' + id), {
            isSoldOut: !currentStatus
        });
    }
</script>
</body>
</html>