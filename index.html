<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brew & Beats - Symphony of Talent</title>
    <link href="https://fonts.googleapis.com/css2?family=Limelight&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Style untuk item yang Sold Out */
        .menu-item.sold-out {
            opacity: 0.6; /* Membuat agak transparan */
            filter: grayscale(100%); /* Membuat jadi hitam putih */
        }
        .menu-item.sold-out .item-name span {
            filter: none; /* Biarkan tulisan (HABIS) tetap berwarna merah */
        }
        :root {
            --bg-color: #19194d;
            --accent-color: #a4a4e0;
            --text-color: #ffffff;
            --card-bg: #24245e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
            line-height: 1.5;
            padding-bottom: 80px;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        /* --- Header --- */
        header {
            cursor: pointer;
            text-align: center; margin-bottom: 40px; border: 2px solid var(--accent-color); padding: 20px; position: relative;
            transition: transform 0.2s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        header:hover{
            transform: scale(1.01); /* Naik sedikit dan scale up sedikit */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6); /* Bayangan lebih kuat */
        }
        header::before, header::after {
            content: ''; position: absolute; width: 10px; height: 10px; border: 2px solid var(--accent-color); background: var(--bg-color);
        }
        header::before { top: -6px; left: -6px; }
        header::after { bottom: -6px; right: -6px; }
        h1 { font-family: 'Limelight', cursive; font-size: 2.5rem; color: var(--accent-color); }
        h2 { font-family: 'Limelight', cursive; font-size: 1.8rem; }

        /* --- Menu & Grid --- */
        .menu-section { margin-bottom: 40px; }
        .category-banner {
            background-color: #3a3a7a; color: #fff; font-weight: 800; font-size: 1.5rem; padding: 5px 20px;
            clip-path: polygon(0 0, 95% 0, 100% 50%, 95% 100%, 0 100%); display: inline-block; margin-bottom: 15px;
        }
        .menu-grid { display: grid; gap: 15px; }
        .menu-item {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed var(--accent-color);
        }
        .item-info { flex-grow: 1; }
        .item-name { font-weight: 600; font-size: 1.1rem; }
        .item-desc { font-size: 0.8rem; opacity: 0.7; }
        .item-action { display: flex; align-items: center; gap: 15px; min-width: 120px; justify-content: flex-end; }
        .item-price { font-family: 'Limelight', cursive; font-size: 1.2rem; color: var(--accent-color); }
        .btn-add {
            background-color: var(--accent-color); color: var(--bg-color); border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; transition: transform 0.2s;
        }
        .btn-add:hover { transform: scale(1.1); background-color: #fff; }

        /* --- Floating Cart & Modal --- */
        #floating-cart {
            position: fixed; bottom: 20px; right: 20px; background-color: var(--accent-color); color: var(--bg-color); padding: 15px 25px; border-radius: 30px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 99; display: flex; align-items: center; gap: 10px;
        }
        .cart-count { background: var(--bg-color); color: var(--accent-color); padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; }

        /* --- Universal Modal Styles (Cart & Custom) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; visibility: hidden;
        }
        .modal.active { visibility: visible; }
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); opacity: 0; transition: opacity 0.3s;
        }
        .modal.active .modal-overlay { opacity: 1; }
        
        /* Cart Specific Modal (Slide from right) */
        #cart-modal .modal-content {
            position: absolute; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100vh; background-color: #24245e; transition: right 0.3s ease; display: flex; flex-direction: column;
        }
        #cart-modal.active .modal-content { right: 0; }

        /* Custom Add-on Specific Modal (Popup in center) */
        #custom-modal .modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); 
            width: 90%; max-width: 350px; background-color: #24245e; padding: 25px; border-radius: 15px; 
            border: 2px solid var(--accent-color); opacity: 0; transition: all 0.3s ease;
        }
        #custom-modal.active .modal-content { transform: translate(-50%, -50%) scale(1); opacity: 1; }

        /* --- Modal Inner Elements --- */
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .modal-header h3 { font-family: 'Limelight', cursive; color: var(--accent-color); }
        .close-btn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        
        .cart-items { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #333370; }
        .cart-item-details small { display: block; opacity: 0.7; }
        .cart-item-actions { display: flex; gap: 10px; align-items: center; }
        .btn-qty { background: var(--bg-color); color: var(--accent-color); border: 1px solid var(--accent-color); width: 25px; height: 25px; border-radius: 50%; cursor: pointer; }
        
        .modal-footer { padding: 20px; background: #1a1a4a; border-top: 2px solid var(--accent-color); }
        .total-row { display: flex; justify-content: space-between; font-size: 1.2rem; margin-bottom: 15px; font-weight: bold; }
        .btn-primary { width: 100%; padding: 12px; background-color: var(--accent-color); color: var(--bg-color); border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-whatsapp { background-color: #25D366; color: white; }

        /* --- Custom Add-on Form --- */
        .addon-group { margin-bottom: 20px; }
        .addon-option {
            display: flex; justify-content: space-between; padding: 10px; background: #1a1a4a; margin-bottom: 8px; border-radius: 8px; cursor: pointer;
        }
        .addon-option input { margin-right: 10px; }

        footer { text-align: center; margin-top: 50px; padding: 20px; border-top: 1px solid var(--accent-color); opacity: 0.7; font-size: 0.9rem; }
        /* --- NEW CSS: Form Data Diri --- */
        .customer-form { background: #15153a; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .form-group { margin-bottom: 10px; }
        .form-label { display: block; font-size: 0.9rem; margin-bottom: 5px; opacity: 0.8; }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--accent-color); background: #0f0f2e; color: #fff; border-radius: 5px; font-family: inherit; }
        .form-input:focus { outline: none; border-color: #fff; }
        .form-select {
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--accent-color); 
            background: #0f0f2e; 
            color: #fff; 
            border-radius: 5px; 
            font-family: inherit;
            /* Baris ini untuk memunculkan panah dropdown kustom */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        .form-select:focus { 
            outline: none; 
            border-color: #fff; 
        }
        .form-select option {
            background-color: #1a1a4a;
            color: #fff;
        }
        /* Tambahan untuk memastikan modal pembayaran selalu paling atas */
        /* --- CSS TAMBAHAN UNTUK MODAL PEMBAYARAN --- */
        /* --- MODAL PEMBAYARAN PREMIUM --- */
        /* === MODAL PEMBAYARAN PREMIUM (VERSI RINGKAS/ANTI-SCROLL) === */
        #payment-modal {
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        #payment-modal .modal-content {
            position: relative;
            top: auto; left: auto; right: auto; bottom: auto;
            transform: none;
            width: 85%; max-width: 340px; /* Lebih ramping */
            max-height: 95vh; /* Jaga-jaga di layar sangat pendek */
            background: linear-gradient(160deg, #24245e 0%, #1a1a4a 100%);
            border-radius: 20px;
            border: 1px solid var(--accent-color);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* -- HEADER RINGKAS -- */
        #payment-modal .modal-header {
            padding: 12px 15px; /* Lebih tipis */
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(164, 164, 224, 0.2);
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        #payment-modal .modal-header h3 {
            font-family: 'Limelight', cursive; color: var(--accent-color);
            font-size: 1.3rem; margin: 0; letter-spacing: 1px;
        }
        #payment-modal .close-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            width: 30px; height: 30px; border-radius: 50%;
            background: rgba(255,255,255,0.1); color: #fff;
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer;
        }

        /* -- BODY RINGKAS -- */
        #payment-modal .modal-body {
            padding: 15px; /* Padding minimalis */
            text-align: center;
            overflow-y: auto; /* Scroll hanya jika terpaksa sekali */
            display: flex; flex-direction: column; align-items: center;
        }

        /* Teks Instruksi Kecil */
        .instruction-text {
            font-size: 0.85rem; color: #e0e0ff;
            margin-bottom: 10px; line-height: 1.3;
        }

        /* Area QRIS Dipadatkan */
        #qris-area {
            background: #fff;
            padding: 8px; /* Padding putih tipis */
            border-radius: 12px;
            margin: 5px auto 15px auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        /* PENTING: Paksa ukuran QR agar pas di satu layar */
        #qris-area img, #qris-area canvas {
            width: 150px !important;
            height: 150px !important;
            display: block;
        }

        /* Total Box Sebaris (Hemat Tempat) */
        .total-box {
            width: 100%;
            background: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid rgba(164, 164, 224, 0.3);
            margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center; /* Kiri-Kanan */
        }
        .total-box span:first-child {
            font-family: 'Montserrat', sans-serif; font-size: 0.9rem;
            color: #ccc; text-transform: uppercase; letter-spacing: 0.5px;
            margin: 0; /* Hilangkan margin bawah */
        }
        #payment-total {
            font-family: 'Montserrat', sans-serif; color: #4ade80; /* Hijau soft */
            font-size: 1.5rem; /* Ukuran pas untuk sebaris */
            margin: 0; text-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }

        /* Catatan Kaki Kecil */
        .note-text {
            font-size: 0.75rem; color: rgba(255,255,255,0.5);
            margin-bottom: 15px; font-style: italic; line-height: 1.2;
        }

        /* Tombol Ramping */
        .btn-whatsapp-confirm {
            background: var(--accent-color); color: var(--bg-color);
            width: 100%; padding: 12px; /* Lebih tipis dari sebelumnya */
            border: none; border-radius: 12px;
            font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 0.95rem;
            text-transform: uppercase; letter-spacing: 0.5px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s;
        }
        .btn-whatsapp-confirm:hover { filter: brightness(1.1); transform: translateY(-2px); }
        /* --- AKHIR CSS MODAL PREMIUM --- */
        #countdown-banner {
            background: linear-gradient(45deg, var(--accent-color), #c084fc); /* Gradasi ungu yang menarik */
            color: var(--bg-color); /* Teks gelap agar kontras */
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            text-align: center;
            padding: 10px 15px;
            
            /* Ini yang membuatnya menempel di atas */
            position: sticky;
            top: 0;
            z-index: 1000; /* Pastikan di atas segalanya, kecuali modal */
            
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap; /* Agar rapi di HP */
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #timer {
            display: flex;
            gap: 10px;
            font-weight: 800;
        }

        #timer > div {
            background: rgba(0,0,0,0.1);
            padding: 5px 10px;
            border-radius: 5px;
            min-width: 60px; /* Agar lebar kotak seragam */
        }

        #timer span {
            font-family: 'Montserrat', sans-serif; /* Pakai font angka yang keren */
            font-size: 1.5rem;
            display: block;
            line-height: 1.1;
        }

        /* Tampilan di HP */
        @media (max-width: 480px) {
            #countdown-banner {
                flex-direction: column;
                gap: 5px;
                padding: 8px;
            }
            #timer { gap: 5px; }
            #timer > div { padding: 3px 6px; min-width: 50px; }
            #timer span { font-size: 1.2rem; }
        }
        /* --- CSS UNTUK PO DITUTUP --- */
        .po-closed-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: rgba(25, 25, 77, 0.9); /* Latar gelap transparan */
            backdrop-filter: blur(10px); /* Blur konten di belakang */
            z-index: 999; /* Di bawah countdown banner, di atas segalanya */
            
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .overlay-content h2 {
            font-family: 'Limelight', cursive;
            color: var(--accent-color);
            font-size: 2.5rem;
            text-shadow: 0 0 15px var(--accent-color);
        }
        .overlay-content p {
            font-size: 1.1rem;
            color: #eee;
            margin-bottom: 30px;
        }
        .overlay-content a {
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            font-size: 1rem;
            padding: 12px 25px;
            background: var(--accent-color);
            color: var(--bg-color);
            border-radius: 30px;
            text-decoration: none;
            transition: all 0.2s;
        }
        .overlay-content a:hover {
            background: #fff;
            transform: scale(1.05);
        }
        /* --- STYLE TOMBOL ADMIN (BARU) --- */
        #admin-trigger-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10001; /* Harus lebih tinggi dari overlay (999) dan banner (1000) */
            
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            
            width: 45px;
            height: 45px;
            border-radius: 50%;
            
            display: flex;
            align-items: center;
            justify-content: center;
            
            cursor: pointer;
            opacity: 0.4; /* Samar saat tidak disentuh */
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #admin-trigger-btn:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.9);
            transform: rotate(90deg); /* Efek putar saat hover */
        }
    </style>
</head>
<body>
    <div id="countdown-banner">
        Pre-Order Ditutup Dalam: 
        <div id="timer">
            <div><span id="days">0</span> Hari</div>
            <div><span id="hours">0</span> Jam</div>
            <div><span id="minutes">0</span> Menit</div>
            <div><span id="seconds">0</span> Detik</div>
        </div>
    </div>
    <div class="container">
        <header onclick="window.location.href='leaderboard.html'">
            <h1>Brew & Beats</h1>
            <h2>SYMPHONY OF TALENT</h2>
        </header>
        <main id="menu-container"></main>
        <footer>Pre-order: Nov 12-19, 2025</footer>
    </div>

    <div id="floating-cart" onclick="toggleModal('cart-modal')">
        <span>üõçÔ∏è Keranjang</span><span class="cart-count" id="cart-count">0</span>
    </div>

    <div id="custom-modal" class="modal">
        <div class="modal-overlay" onclick="toggleModal('custom-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="custom-item-name">Kustomisasi</h3>
                <button class="close-btn" onclick="toggleModal('custom-modal')">√ó</button>
            </div>
            <div id="addon-form">
                </div>
            <div class="total-row" style="font-size: 1rem; margin-top: 20px;">
                <span>Total Item:</span>
                <span id="custom-item-total">Rp 0</span>
            </div>
            <button class="btn-primary" id="btn-confirm-add">Tambahkan ke Keranjang</button>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-overlay" onclick="toggleModal('cart-modal')"></div>
        <div class="modal-content">
            <div class="modal-header" style="padding: 20px; background: #1a1a4a;">
                <h3>Pesanan Anda</h3>
                <button class="close-btn" onclick="toggleModal('cart-modal')">√ó</button>
            </div>
            <div class="cart-items" id="cart-items-container"></div>
            <div class="modal-footer">
                <div class="customer-form">
                    <div class="form-group">
                        <label class="form-label">Nama Pemesan *</label>
                        <input type="text" id="cust-name" class="form-input" placeholder="Contoh: Budi Santoso">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kelas *</label>
                        <select id="cust-class" class="form-select">
                            <option value="">-- Pilih Kelas --</option>
                            <option value="PPBP 7">PPBP 7</option>
                            <option value="PPBP 8">PPBP 8</option>
                            <option value="PPBP 9">PPBP 9</option>
                            <option value="PPBP 10">PPBP 10</option>
                            <option value="PPTI 20">PPTI 20</option>
                            <option value="PPTI 21">PPTI 21</option>
                            <option value="PPTI 22">PPTI 22</option>
                            <option value="PPTI 23">PPTI 23</option>
                            <option value="PPTI 24">PPTI 24</option>
                            <option value="PPTI 25">PPTI 25</option>
                            <option value="DPP">DPP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nomor HP (WhatsApp) *</label>
                        <input type="tel" id="cust-phone" class="form-input" placeholder="Contoh: 08123456789">
                    </div>
                </div>
                <div class="total-row">
                    <span>Total:</span><span id="cart-total">Rp 0</span>
                </div>
                <button class="btn-primary btn-whatsapp" onclick="startPaymentProcess()">Lanjut Pembayaran QRIS</button>
            </div>
        </div>
    </div>
    <div id="payment-modal" class="modal">
        <div class="modal-overlay"></div> 
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pembayaran QRIS</h3>
                <button class="close-btn" onclick="toggleModal('payment-modal')">√ó</button>
            </div>
            
            <div class="modal-body">
                <p class="instruction-text">
                    Scan QRIS di bawah. Nominal akan muncul <strong>otomatis</strong> di aplikasi Anda.
                </p>
                
                <div id="qris-area"></div>

                <div class="total-box">
                    <span>Total Tagihan</span>
                    <span id="payment-total">Rp 0</span>
                </div>

                <p class="note-text">
                    *Pastikan nominal di aplikasi sama persis dengan total di atas.
                </p>

                <button class="btn-whatsapp-confirm" onclick="confirmOrderAutomatic()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    SAYA SUDAH TRANSFER
                </button>
            </div>
        </div>
    </div>
    <div id="admin-trigger-btn" title="Admin Login">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
    </div>
    <script type="module">
        import { getDatabase, ref, onValue, push, set, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        // --- 1. IMPORT FIREBASE (JANGAN DIUBAH) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

        // --- 2. CONFIG FIREBASE (WAJIB DIGANTI DENGAN PUNYAMU) ---
        // Ambil ini dari Firebase Console -> Project Settings -> General -> Your Apps
        const firebaseConfig = {
            apiKey: "AIzaSyCU82AX-l80wXvxb_S4eToRQ0cRt8RXZa4",
            authDomain: "brew-and-beats-5fbf2.firebaseapp.com",
            databaseURL: "https://brew-and-beats-5fbf2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "brew-and-beats-5fbf2",
            storageBucket: "brew-and-beats-5fbf2.firebasestorage.app",
            messagingSenderId: "243138026852",
            appId: "1:243138026852:web:73d5e7cdb446949033ee71",
            measurementId: "G-S3ZX1F1FTP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 3. VARIABEL GLOBAL ---
        // Kita pakai 'window.' supaya bisa dibaca di seluruh halaman
        window.cart = [];
        window.currentCustomItem = null;
        window.lastUniqueCode = 0;
        window.secretClicks = 0;
        
        // Data Menu sekarang kosong dulu, nanti diisi otomatis dari Firebase
        window.MENU_DATA = []; 

        // Data Add-ons (Tetap hardcoded karena jarang berubah)
        window.ADD_ONS_DATA = [
            { id: 'ao1', name: "Extra Shot", price: 3000 },
            { id: 'ao2', name: "Extra Sugar", price: 2000 },
            { id: 'ao3', name: "Less Sugar", price: 0 }
        ];

        // --- 4. TARIK DATA DARI FIREBASE (REALTIME) ---
        const menuRef = ref(db, 'menu');
        
        onValue(menuRef, (snapshot) => {
            const data = snapshot.val();
            
            // Reset MENU_DATA setiap kali ada perubahan di database
            window.MENU_DATA = [
                { category: "DRINKS", items: [] },
                { category: "TREATS", items: [] }
            ];

            if (data) {
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    // Format item agar sesuai dengan kode lama
                    const formattedItem = {
                        id: key, 
                        name: item.name,
                        price: item.price,
                        desc: item.desc,
                        supportsAddons: item.supportsAddons,
                        // Ambil stok, kalau tidak ada anggap 0
                        stock: item.stock !== undefined ? item.stock : 0, 
                        // Item dianggap sold out jika dicentang manual ATAU stoknya 0/kurang
                        isSoldOut: item.isSoldOut || (item.stock !== undefined && item.stock <= 0)
                    };

                    // Masukkan ke kategori yang pas
                    const catIndex = window.MENU_DATA.findIndex(c => c.category === item.category);
                    if (catIndex !== -1) {
                        window.MENU_DATA[catIndex].items.push(formattedItem);
                    }
                });
            }

            // Setelah data siap, render ulang tampilan
            window.renderMenu();
        });


        // --- 5. FUNGSI-FUNGSI UTAMA (Diubah jadi window.namaFungsi) ---

        // Render Menu
        window.renderMenu = function() {
            const container = document.getElementById('menu-container');
            container.innerHTML = ''; 

            window.MENU_DATA.forEach(section => {
                const sectionEl = document.createElement('section');
                sectionEl.className = 'menu-section';
                sectionEl.innerHTML = `<div class="category-banner">${section.category}</div><div class="menu-grid" id="grid-${section.category}"></div>`;
                container.appendChild(sectionEl);

                const gridEl = sectionEl.querySelector(`#grid-${section.category}`);
                
                section.items.forEach(item => {
                    const displayPrice = (item.price / 1000) + "k";
                    let itemClass = "menu-item";
                    let btnState = "";
                    let btnText = "+";
                    let btnStyle = "";
                    let nameLabel = item.name;
                    
                    // --- LOGIKA STOK DI SINI ---
                    let stockDisplay = "";
                    
                    // Jika stok ada (lebih dari 0), tampilkan sisa
                    if (!item.isSoldOut && item.stock > 0) {
                        stockDisplay = `<div style="font-size: 0.75rem; color: #a4a4e0; margin-top: 4px;">‚ö° Sisa Stok: <strong>${item.stock}</strong></div>`;
                    }

                    // Cek logic Sold Out (berdasarkan manual flag atau stok 0)
                    // Note: di langkah 1 kita sudah set isSoldOut jadi true kalau stok <= 0
                    if (item.isSoldOut) {
                        itemClass += " sold-out";
                        btnState = "disabled";
                        btnText = "X";
                        btnStyle = "background-color: #555; cursor: not-allowed;"; 
                        nameLabel += ` <span style="color:#ff4d4d; font-size:0.8em; font-weight:bold;">(HABIS)</span>`;
                        stockDisplay = `<div style="font-size: 0.75rem; color: #ff4d4d; margin-top: 4px;">Stok Habis</div>`;
                    }
                    
                    // Tentukan action (jika sold out, action kosong)
                    let action = "";
                    if (!item.isSoldOut) {
                         action = item.supportsAddons ? `openCustomModal('${item.id}')` : `directAddToCart('${item.id}')`;
                    }

                    gridEl.innerHTML += `
                        <div class="${itemClass}">
                            <div class="item-info">
                                <div class="item-name">${nameLabel}</div>
                                ${item.desc ? `<div class="item-desc">${item.desc}</div>` : ''}
                                ${stockDisplay}
                            </div>
                            <div class="item-action">
                                <div class="item-price">${displayPrice}</div>
                                <button class="btn-add" ${btnState} style="${btnStyle}" onclick="${action}">${btnText}</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // Toggle Modal
        window.toggleModal = function(modalId) {
            document.getElementById(modalId).classList.toggle('active');
        }

        // Open Custom Modal
        window.openCustomModal = function(itemId) {
            for (const section of window.MENU_DATA) {
                const found = section.items.find(i => i.id === itemId);
                if (found) {
                    window.currentCustomItem = { ...found, selectedAddons: [] };
                    break;
                }
            }

            document.getElementById('custom-item-name').innerText = window.currentCustomItem.name;
            const addonForm = document.getElementById('addon-form');
            addonForm.innerHTML = '<p style="margin-bottom:10px; opacity:0.8">Pilih tambahan (opsional):</p>';
            
            window.ADD_ONS_DATA.forEach(addon => {
                addonForm.innerHTML += `
                    <label class="addon-option">
                        <span>
                            <input type="checkbox" data-id="${addon.id}" data-price="${addon.price}" data-name="${addon.name}" onchange="updateCustomTotal()">
                            ${addon.name}
                        </span>
                        <span>+${addon.price.toLocaleString('id-ID')}</span>
                    </label>
                `;
            });

            window.updateCustomTotal();
            window.toggleModal('custom-modal');
            document.getElementById('btn-confirm-add').onclick = () => window.confirmAddToCart();
        }

        // Update Custom Total
        window.updateCustomTotal = function() {
            const checkboxes = document.querySelectorAll('#addon-form input[type="checkbox"]:checked');
            let addonTotal = 0;
            window.currentCustomItem.selectedAddons = []; 

            checkboxes.forEach(box => {
                addonTotal += parseInt(box.dataset.price);
                window.currentCustomItem.selectedAddons.push({
                    id: box.dataset.id,
                    name: box.dataset.name,
                    price: parseInt(box.dataset.price)
                });
            });

            const total = window.currentCustomItem.price + addonTotal;
            document.getElementById('custom-item-total').innerText = 'Rp ' + total.toLocaleString('id-ID');
        }

        // Direct Add To Cart
        window.directAddToCart = function(itemId) {
            for (const section of window.MENU_DATA) {
                const found = section.items.find(i => i.id === itemId);
                if (found) {
                    window.addItemToCartInternal(found, []);
                    break;
                }
            }
        }

        // Confirm Add To Cart
        window.confirmAddToCart = function() {
            window.addItemToCartInternal(window.currentCustomItem, window.currentCustomItem.selectedAddons);
            window.toggleModal('custom-modal');
        }

        // Internal Add Item Logic
        window.addItemToCartInternal = function(product, addOns) {
            const internalId = Date.now() + Math.random().toString(36).substr(2, 9);
            const addonsTotal = addOns.reduce((sum, ao) => sum + ao.price, 0);
            const finalPrice = product.price + addonsTotal;

            window.cart.push({
                internalId: internalId,
                productId: product.id,
                name: product.name,
                basePrice: product.price,
                addOns: addOns,
                finalPrice: finalPrice,
                qty: 1
            });

            window.updateCartUI();
            
            const floatCart = document.getElementById('floating-cart');
            floatCart.style.transform = 'scale(1.1)';
            setTimeout(() => floatCart.style.transform = 'scale(1)', 200);
        }

        // Update Qty
        window.updateCartQty = function(internalId, change) {
            const itemIndex = window.cart.findIndex(item => item.internalId === internalId);
            if (itemIndex > -1) {
                window.cart[itemIndex].qty += change;
                if (window.cart[itemIndex].qty <= 0) window.cart.splice(itemIndex, 1);
                window.updateCartUI();
            }
        }

        // Update UI Cart
        window.updateCartUI = function() {
            const totalQty = window.cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cart-count').innerText = totalQty;

            const cartContainer = document.getElementById('cart-items-container');
            if (window.cart.length === 0) {
                cartContainer.innerHTML = '<p style="opacity: 0.5; text-align: center; margin-top: 50px;">Keranjang kosong.</p>';
                document.getElementById('cart-total').innerText = 'Rp 0';
                return;
            }

            cartContainer.innerHTML = '';
            let grandTotal = 0;

            window.cart.forEach(item => {
                grandTotal += (item.finalPrice * item.qty);
                let addonsHTML = '';
                if (item.addOns.length > 0) {
                    addonsHTML = '<small>+ ' + item.addOns.map(ao => ao.name).join(', ') + '</small>';
                }

                cartContainer.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-item-details">
                            <strong>${item.name}</strong>
                            ${addonsHTML}
                            <div>@ Rp ${item.finalPrice.toLocaleString('id-ID')}</div>
                        </div>
                        <div class="cart-item-actions">
                            <button class="btn-qty" onclick="updateCartQty('${item.internalId}', -1)">-</button>
                            <span>${item.qty}</span>
                            <button class="btn-qty" onclick="updateCartQty('${item.internalId}', 1)">+</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('cart-total').innerText = 'Rp ' + grandTotal.toLocaleString('id-ID');
        }

        // --- LOGIKA PAYMENT & QRIS (Backend Vercel) ---
        window.startPaymentProcess = async function() {
            if (window.cart.length === 0) return alert("Keranjang kosong!");
            
            const name = document.getElementById('cust-name').value.trim();
            const cls = document.getElementById('cust-class').value;
            const phone = document.getElementById('cust-phone').value.trim();
            
            if (!name || !cls || !phone) return alert("Mohon lengkapi data diri.");
            if (name.length <= 3) return alert("Nama kependekan.");
            if (!/^\d+$/.test(phone) || phone.length < 10) return alert("Nomor HP tidak valid.");

            // --- PERUBAHAN 1: CEK STOK DULU SEBELUM MUNCUL QRIS ---
            const btnLanjut = document.querySelector('.btn-whatsapp');
            const txtAsli = btnLanjut.innerText;
            btnLanjut.innerText = "‚è≥ Mengecek Stok...";
            btnLanjut.disabled = true;

            try {
                // Kita cek stok semua item di keranjang satu per satu
                const stockChecks = window.cart.map(async (item) => {
                    const snapshot = await get(ref(db, 'menu/' + item.productId + '/stock'));
                    const currentStock = snapshot.val() || 0;
                    return { 
                        name: item.name, 
                        cukup: currentStock >= item.qty,
                        sisa: currentStock 
                    };
                });

                const results = await Promise.all(stockChecks);
                const itemHabis = results.find(r => !r.cukup);

                if (itemHabis) {
                    alert(`‚ùå Maaf, stok untuk "${itemHabis.name}" barusan berubah. Sisa: ${itemHabis.sisa}. Mohon kurangi jumlah pesanan.`);
                    btnLanjut.innerText = txtAsli;
                    btnLanjut.disabled = false;
                    return; // STOP! JANGAN LANJUT KE PEMBAYARAN
                }

                // --- KALAU STOK AMAN, LANJUT GENERATE QRIS ---
                let baseTotal = window.cart.reduce((sum, item) => sum + (item.finalPrice * item.qty), 0);
                window.lastUniqueCode = Math.floor(Math.random() * (99 - 10 + 1)) + 10;
                let finalTransferAmount = baseTotal + window.lastUniqueCode;

                document.getElementById('payment-total').innerText = 'Rp ' + finalTransferAmount.toLocaleString('id-ID');
                document.getElementById('qris-area').innerHTML = '<p style="opacity: 0.7;">‚è≥ Sedang membuat QRIS...</p>';
                
                window.toggleModal('cart-modal');
                setTimeout(() => window.toggleModal('payment-modal'), 300);

                // API Call Generate QRIS
                const response = await fetch('/api/generate-qris', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: finalTransferAmount })
                });
                
                if (!response.ok) throw new Error("Gagal generate QRIS");
                const data = await response.json();

                if (data.qr_string) {
                    document.getElementById('qris-area').innerHTML = ""; 
                    new QRCode(document.getElementById('qris-area'), {
                        text: data.qr_string,
                        width: 200, height: 200,
                        correctLevel : QRCode.CorrectLevel.L
                    });
                } else { throw new Error("QR String kosong"); }

            } catch (error) {
                console.error(error);
                alert("Gagal memuat pembayaran. Coba lagi.");
            } finally {
                btnLanjut.innerText = txtAsli;
                btnLanjut.disabled = false;
            }
        }

        // --- GANTI FUNGSI confirmOrderAutomatic DENGAN INI ---
        window.confirmOrderAutomatic = async function() {
            const name = document.getElementById('cust-name').value.trim();
            const phone = document.getElementById('cust-phone').value.trim();
            const cls = document.getElementById('cust-class').value;
            
            if(!name || !phone) return alert("Isi nama dan nomor HP dulu!");

            const btn = document.querySelector('.btn-whatsapp-confirm');
            const originalText = btn.innerHTML; // Simpan teks asli tombol
            btn.innerHTML = '‚è≥ Memproses Stok...';
            btn.disabled = true;

            // --- LOGIKA POTONG STOK ---
            const updates = window.cart.map(item => {
                const itemRef = ref(db, 'menu/' + item.productId + '/stock');
                return runTransaction(itemRef, (currentStock) => {
                    if (currentStock === null) return 0;
                    if (currentStock >= item.qty) {
                        return currentStock - item.qty;
                    } else {
                        return; // Batalkan transaksi jika stok kurang
                    }
                });
            });

            try {
                const results = await Promise.all(updates);
                const failed = results.some(result => !result.committed);

                if (failed) {
                    // --- SKENARIO APES: SUDAH BAYAR TAPI STOK HABIS ---
                    alert("‚ö†Ô∏è WADUH! Stok item ini barusan habis diserobot orang lain.\n\nKarena kamu SUDAH BAYAR, silakan klik tombol di bawah untuk lapor Admin (Sertakan Bukti Transfer). Uang akan direfund atau ganti menu.");
                    
                    // Ubah tombol konfirmasi jadi tombol WhatsApp Admin
                    btn.style.backgroundColor = "#ff4d4d"; // Warna merah darurat
                    btn.innerHTML = "üì¢ LAPOR ADMIN (REFUND/GANTI)";
                    btn.disabled = false;
                    
                    // Buat pesan WhatsApp otomatis
                    const totalBayar = document.getElementById('payment-total').innerText;
                    const detailOrder = window.cart.map(i => `${i.name} (${i.qty}x)`).join(', ');
                    const pesanWA = `Halo, saya *${name}* (${cls}).%0a%0aSaya sudah transfer *${totalBayar}* via QRIS.%0aTapi saat konfirmasi di web, sistem bilang *STOK HABIS*.%0a%0aDetail Pesanan:%0a${detailOrder}%0a%0aMohon dicek bukti transfer saya (saya lampirkan foto).`;
                    
                    // Ganti fungsi tombol biar pas diklik lari ke WA
                    btn.onclick = function() {
                        window.open(`https://wa.me/6287788448765?text=${pesanWA}`, '_blank'); // GANTI NO WA ADMIN DISINI
                    };
                    
                    return; // Stop proses, jangan simpan order sukses
                }

                // --- KALAU SUKSES ---
                let orderId = "ORD-" + Date.now().toString().slice(-6);
                let itemsReport = window.cart.map(i => `${i.name} (${i.qty}x)`).join(', ');

                const ordersRef = ref(db, 'orders/' + orderId);
                set(ordersRef, {
                    customer: name,
                    class: cls,
                    phone: phone,
                    items: itemsReport,
                    orderDetails: cartComplete,
                    total: document.getElementById('payment-total').innerText,
                    status: 'paid', // Langsung paid karena ini QRIS
                    timestamp: Date.now()
                });

                window.toggleModal('payment-modal');
                alert(`‚úÖ PESANAN BERHASIL!\nOrder ID: ${orderId}\nPesanan sudah diamankan untukmu!.`);
                
                window.cart = [];
                window.updateCartUI();
                window.location.reload();

            } catch (error) {
                console.error(error);
                alert("Terjadi kesalahan koneksi.");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- 6. LOGIKA COUNTDOWN (Timer) ---
        window.startCountdown = function() {
            const countdownDate = new Date("November 19, 2025 23:59:59").getTime();
            const timerInterval = setInterval(function() {
                const now = new Date().getTime();
                const distance = countdownDate - now;

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById("days").innerText = days;
                document.getElementById("hours").innerText = hours;
                document.getElementById("minutes").innerText = minutes;
                document.getElementById("seconds").innerText = seconds;

                if (distance < 0) {
                    overlay.innerHTML = `
                        <div class="overlay-content">
                            <h2>Pre-Order Ditutup</h2> <p>Sampai jumpa di PO berikutnya.</p>
                            <a href="leaderboard.html">Lihat Klasemen</a>
                        </div>`;
                }
            }, 1000);
        }
        
        // --- 7. ADMIN LOGIN (SECURE VIA VERCEL API) ---
        
        // Pasang event listener ke tombol icon saat script jalan
        const adminBtn = document.getElementById('admin-trigger-btn');
        if(adminBtn) {
            adminBtn.addEventListener('click', handleAdminLogin);
        }

        async function handleAdminLogin() {
            // 1. Minta Password
            const passwordInput = prompt("üîí Masukkan Password Admin:");
            if (!passwordInput) return;

            document.body.style.cursor = 'wait';

            try {
                // 2. Tanya ke Server (API Vercel)
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ passwordInput: passwordInput })
                });

                const result = await response.json();

                // 3. Cek Jawaban Server
                if (result.allowed === true) {
                    // --- [PENTING] INI YANG BIASANYA KETINGGALAN ---
                    // Kita cetak "Tiket" bernama 'isAdmin' isinya 'true'
                    sessionStorage.setItem('isAdmin', 'true'); 
                    // ------------------------------------------------
                    window.location.href = 'admin.html'; 
                } else {
                    alert("‚ùå Password Salah!");
                }
            } catch (error) {
                console.error(error);
                alert("‚ö†Ô∏è Gagal menghubungi server.");
            } finally {
                document.body.style.cursor = 'default';
            }
        }
        
        // Jalankan timer saat load
        window.startCountdown();

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</body>
</html>