<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brew & Beats - Symphony of Talent</title>
    <link href="https://fonts.googleapis.com/css2?family=Limelight&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Style untuk item yang Sold Out */
        .menu-item.sold-out {
            opacity: 0.6; /* Membuat agak transparan */
            filter: grayscale(100%); /* Membuat jadi hitam putih */
        }
        .menu-item.sold-out .item-name span {
            filter: none; /* Biarkan tulisan (HABIS) tetap berwarna merah */
        }
        :root {
            --bg-color: #19194d;
            --accent-color: #a4a4e0;
            --text-color: #ffffff;
            --card-bg: #24245e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
            line-height: 1.5;
            padding-bottom: 80px;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        /* --- Header --- */
        header {
            cursor: pointer;
            text-align: center; margin-bottom: 40px; border: 2px solid var(--accent-color); padding: 20px; position: relative;
            transition: transform 0.2s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        header:hover{
            transform: scale(1.01); /* Naik sedikit dan scale up sedikit */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6); /* Bayangan lebih kuat */
        }
        header::before, header::after {
            content: ''; position: absolute; width: 10px; height: 10px; border: 2px solid var(--accent-color); background: var(--bg-color);
        }
        header::before { top: -6px; left: -6px; }
        header::after { bottom: -6px; right: -6px; }
        h1 { font-family: 'Limelight', cursive; font-size: 2.5rem; color: var(--accent-color); }
        h2 { font-family: 'Limelight', cursive; font-size: 1.8rem; }

        /* --- Menu & Grid --- */
        .menu-section { margin-bottom: 40px; }
        .category-banner {
            background-color: #3a3a7a; color: #fff; font-weight: 800; font-size: 1.5rem; padding: 5px 20px;
            clip-path: polygon(0 0, 95% 0, 100% 50%, 95% 100%, 0 100%); display: inline-block; margin-bottom: 15px;
        }
        .menu-grid { display: grid; gap: 15px; }
        .menu-item {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed var(--accent-color);
        }
        .item-info { flex-grow: 1; }
        .item-name { font-weight: 600; font-size: 1.1rem; }
        .item-desc { font-size: 0.8rem; opacity: 0.7; }
        .item-action { display: flex; align-items: center; gap: 15px; min-width: 120px; justify-content: flex-end; }
        .item-price { font-family: 'Limelight', cursive; font-size: 1.2rem; color: var(--accent-color); }
        .btn-add {
            background-color: var(--accent-color); color: var(--bg-color); border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; transition: transform 0.2s;
        }
        .btn-add:hover { transform: scale(1.1); background-color: #fff; }

        /* --- Floating Cart & Modal --- */
        #floating-cart {
            position: fixed; bottom: 20px; right: 20px; background-color: var(--accent-color); color: var(--bg-color); padding: 15px 25px; border-radius: 30px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 99; display: flex; align-items: center; gap: 10px;
        }
        .cart-count { background: var(--bg-color); color: var(--accent-color); padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; }

        /* --- Universal Modal Styles (Cart & Custom) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; visibility: hidden;
        }
        .modal.active { visibility: visible; }
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); opacity: 0; transition: opacity 0.3s;
        }
        .modal.active .modal-overlay { opacity: 1; }
        
        /* Cart Specific Modal (Slide from right) */
        #cart-modal .modal-content {
            position: absolute; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100vh; background-color: #24245e; transition: right 0.3s ease; display: flex; flex-direction: column;
        }
        #cart-modal.active .modal-content { right: 0; }

        /* Custom Add-on Specific Modal (Popup in center) */
        #custom-modal .modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); 
            width: 90%; max-width: 350px; background-color: #24245e; padding: 25px; border-radius: 15px; 
            border: 2px solid var(--accent-color); opacity: 0; transition: all 0.3s ease;
        }
        #custom-modal.active .modal-content { transform: translate(-50%, -50%) scale(1); opacity: 1; }

        /* --- Modal Inner Elements --- */
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .modal-header h3 { font-family: 'Limelight', cursive; color: var(--accent-color); }
        .close-btn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        
        .cart-items { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #333370; }
        .cart-item-details small { display: block; opacity: 0.7; }
        .cart-item-actions { display: flex; gap: 10px; align-items: center; }
        .btn-qty { background: var(--bg-color); color: var(--accent-color); border: 1px solid var(--accent-color); width: 25px; height: 25px; border-radius: 50%; cursor: pointer; }
        
        .modal-footer { padding: 20px; background: #1a1a4a; border-top: 2px solid var(--accent-color); }
        .total-row { display: flex; justify-content: space-between; font-size: 1.2rem; margin-bottom: 15px; font-weight: bold; }
        .btn-primary { width: 100%; padding: 12px; background-color: var(--accent-color); color: var(--bg-color); border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-whatsapp { background-color: #25D366; color: white; }

        /* --- Custom Add-on Form --- */
        .addon-group { margin-bottom: 20px; }
        .addon-option {
            display: flex; justify-content: space-between; padding: 10px; background: #1a1a4a; margin-bottom: 8px; border-radius: 8px; cursor: pointer;
        }
        .addon-option input { margin-right: 10px; }

        footer { text-align: center; margin-top: 50px; padding: 20px; border-top: 1px solid var(--accent-color); opacity: 0.7; font-size: 0.9rem; }
        /* --- NEW CSS: Form Data Diri --- */
        .customer-form { background: #15153a; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .form-group { margin-bottom: 10px; }
        .form-label { display: block; font-size: 0.9rem; margin-bottom: 5px; opacity: 0.8; }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--accent-color); background: #0f0f2e; color: #fff; border-radius: 5px; font-family: inherit; }
        .form-input:focus { outline: none; border-color: #fff; }
        .form-select {
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--accent-color); 
            background: #0f0f2e; 
            color: #fff; 
            border-radius: 5px; 
            font-family: inherit;
            /* Baris ini untuk memunculkan panah dropdown kustom */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        .form-select:focus { 
            outline: none; 
            border-color: #fff; 
        }
        .form-select option {
            background-color: #1a1a4a;
            color: #fff;
        }
        /* Tambahan untuk memastikan modal pembayaran selalu paling atas */
        /* --- CSS TAMBAHAN UNTUK MODAL PEMBAYARAN --- */
        /* --- MODAL PEMBAYARAN PREMIUM --- */
        /* === MODAL PEMBAYARAN PREMIUM (VERSI RINGKAS/ANTI-SCROLL) === */
        #payment-modal {
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        #payment-modal .modal-content {
            position: relative;
            top: auto; left: auto; right: auto; bottom: auto;
            transform: none;
            width: 85%; max-width: 340px; /* Lebih ramping */
            max-height: 95vh; /* Jaga-jaga di layar sangat pendek */
            background: linear-gradient(160deg, #24245e 0%, #1a1a4a 100%);
            border-radius: 20px;
            border: 1px solid var(--accent-color);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* -- HEADER RINGKAS -- */
        #payment-modal .modal-header {
            padding: 12px 15px; /* Lebih tipis */
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(164, 164, 224, 0.2);
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        #payment-modal .modal-header h3 {
            font-family: 'Limelight', cursive; color: var(--accent-color);
            font-size: 1.3rem; margin: 0; letter-spacing: 1px;
        }
        #payment-modal .close-btn {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            width: 30px; height: 30px; border-radius: 50%;
            background: rgba(255,255,255,0.1); color: #fff;
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer;
        }

        /* -- BODY RINGKAS -- */
        #payment-modal .modal-body {
            padding: 15px; /* Padding minimalis */
            text-align: center;
            overflow-y: auto; /* Scroll hanya jika terpaksa sekali */
            display: flex; flex-direction: column; align-items: center;
        }

        /* Teks Instruksi Kecil */
        .instruction-text {
            font-size: 0.85rem; color: #e0e0ff;
            margin-bottom: 10px; line-height: 1.3;
        }

        /* Area QRIS Dipadatkan */
        #qris-area {
            background: #fff;
            padding: 8px; /* Padding putih tipis */
            border-radius: 12px;
            margin: 5px auto 15px auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        /* PENTING: Paksa ukuran QR agar pas di satu layar */
        #qris-area img, #qris-area canvas {
            width: 150px !important;
            height: 150px !important;
            display: block;
        }

        /* Total Box Sebaris (Hemat Tempat) */
        .total-box {
            width: 100%;
            background: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid rgba(164, 164, 224, 0.3);
            margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center; /* Kiri-Kanan */
        }
        .total-box span:first-child {
            font-family: 'Montserrat', sans-serif; font-size: 0.9rem;
            color: #ccc; text-transform: uppercase; letter-spacing: 0.5px;
            margin: 0; /* Hilangkan margin bawah */
        }
        #payment-total {
            font-family: 'Montserrat', sans-serif; color: #4ade80; /* Hijau soft */
            font-size: 1.5rem; /* Ukuran pas untuk sebaris */
            margin: 0; text-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }

        /* Catatan Kaki Kecil */
        .note-text {
            font-size: 0.75rem; color: rgba(255,255,255,0.5);
            margin-bottom: 15px; font-style: italic; line-height: 1.2;
        }

        /* Tombol Ramping */
        .btn-whatsapp-confirm {
            background: var(--accent-color); color: var(--bg-color);
            width: 100%; padding: 12px; /* Lebih tipis dari sebelumnya */
            border: none; border-radius: 12px;
            font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 0.95rem;
            text-transform: uppercase; letter-spacing: 0.5px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s;
        }
        .btn-whatsapp-confirm:hover { filter: brightness(1.1); transform: translateY(-2px); }
        /* --- AKHIR CSS MODAL PREMIUM --- */
        #countdown-banner {
            background: linear-gradient(45deg, var(--accent-color), #c084fc); /* Gradasi ungu yang menarik */
            color: var(--bg-color); /* Teks gelap agar kontras */
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            text-align: center;
            padding: 10px 15px;
            
            /* Ini yang membuatnya menempel di atas */
            position: sticky;
            top: 0;
            z-index: 1000; /* Pastikan di atas segalanya, kecuali modal */
            
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap; /* Agar rapi di HP */
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #timer {
            display: flex;
            gap: 10px;
            font-weight: 800;
        }

        #timer > div {
            background: rgba(0,0,0,0.1);
            padding: 5px 10px;
            border-radius: 5px;
            min-width: 60px; /* Agar lebar kotak seragam */
        }

        #timer span {
            font-family: 'Montserrat', sans-serif; /* Pakai font angka yang keren */
            font-size: 1.5rem;
            display: block;
            line-height: 1.1;
        }

        /* Tampilan di HP */
        @media (max-width: 480px) {
            #countdown-banner {
                flex-direction: column;
                gap: 5px;
                padding: 8px;
            }
            #timer { gap: 5px; }
            #timer > div { padding: 3px 6px; min-width: 50px; }
            #timer span { font-size: 1.2rem; }
        }
        /* --- CSS UNTUK PO DITUTUP --- */
        .po-closed-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: rgba(25, 25, 77, 0.9); /* Latar gelap transparan */
            backdrop-filter: blur(10px); /* Blur konten di belakang */
            z-index: 999; /* Di bawah countdown banner, di atas segalanya */
            
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .overlay-content h2 {
            font-family: 'Limelight', cursive;
            color: var(--accent-color);
            font-size: 2.5rem;
            text-shadow: 0 0 15px var(--accent-color);
        }
        .overlay-content p {
            font-size: 1.1rem;
            color: #eee;
            margin-bottom: 30px;
        }
        .overlay-content a {
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            font-size: 1rem;
            padding: 12px 25px;
            background: var(--accent-color);
            color: var(--bg-color);
            border-radius: 30px;
            text-decoration: none;
            transition: all 0.2s;
        }
        .overlay-content a:hover {
            background: #fff;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div id="countdown-banner">
        Pre-Order Ditutup Dalam: 
        <div id="timer">
            <div><span id="days">0</span> Hari</div>
            <div><span id="hours">0</span> Jam</div>
            <div><span id="minutes">0</span> Menit</div>
            <div><span id="seconds">0</span> Detik</div>
        </div>
    </div>
    <div class="container">
        <header onclick="window.location.href='leaderboard.html'">
            <h1>Brew & Beats</h1>
            <h2>SYMPHONY OF TALENT</h2>
        </header>
        <main id="menu-container"></main>
        <footer>Pre-order: Nov 12-19, 2025</footer>
    </div>

    <div id="floating-cart" onclick="toggleModal('cart-modal')">
        <span>üõçÔ∏è Keranjang</span><span class="cart-count" id="cart-count">0</span>
    </div>

    <div id="custom-modal" class="modal">
        <div class="modal-overlay" onclick="toggleModal('custom-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="custom-item-name">Kustomisasi</h3>
                <button class="close-btn" onclick="toggleModal('custom-modal')">√ó</button>
            </div>
            <div id="addon-form">
                </div>
            <div class="total-row" style="font-size: 1rem; margin-top: 20px;">
                <span>Total Item:</span>
                <span id="custom-item-total">Rp 0</span>
            </div>
            <button class="btn-primary" id="btn-confirm-add">Tambahkan ke Keranjang</button>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-overlay" onclick="toggleModal('cart-modal')"></div>
        <div class="modal-content">
            <div class="modal-header" style="padding: 20px; background: #1a1a4a;">
                <h3>Pesanan Anda</h3>
                <button class="close-btn" onclick="toggleModal('cart-modal')">√ó</button>
            </div>
            <div class="cart-items" id="cart-items-container"></div>
            <div class="modal-footer">
                <div class="customer-form">
                    <div class="form-group">
                        <label class="form-label">Nama Pemesan *</label>
                        <input type="text" id="cust-name" class="form-input" placeholder="Contoh: Budi Santoso">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kelas *</label>
                        <select id="cust-class" class="form-select">
                            <option value="">-- Pilih Kelas --</option>
                            <option value="PPBP 7">PPBP 7</option>
                            <option value="PPBP 8">PPBP 8</option>
                            <option value="PPBP 9">PPBP 9</option>
                            <option value="PPBP 10">PPBP 10</option>
                            <option value="PPTI 20">PPTI 20</option>
                            <option value="PPTI 21">PPTI 21</option>
                            <option value="PPTI 22">PPTI 22</option>
                            <option value="PPTI 23">PPTI 23</option>
                            <option value="PPTI 24">PPTI 24</option>
                            <option value="PPTI 25">PPTI 25</option>
                            <option value="DPP">DPP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nomor HP (WhatsApp) *</label>
                        <input type="tel" id="cust-phone" class="form-input" placeholder="Contoh: 08123456789">
                    </div>
                </div>
                <div class="total-row">
                    <span>Total:</span><span id="cart-total">Rp 0</span>
                </div>
                <button class="btn-primary btn-whatsapp" onclick="startPaymentProcess()">Lanjut Pembayaran QRIS</button>
            </div>
        </div>
    </div>
    <div id="payment-modal" class="modal">
        <div class="modal-overlay"></div> 
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pembayaran QRIS</h3>
                <button class="close-btn" onclick="toggleModal('payment-modal')">√ó</button>
            </div>
            
            <div class="modal-body">
                <p class="instruction-text">
                    Scan QRIS di bawah. Nominal akan muncul <strong>otomatis</strong> di aplikasi Anda.
                </p>
                
                <div id="qris-area"></div>

                <div class="total-box">
                    <span>Total Tagihan</span>
                    <span id="payment-total">Rp 0</span>
                </div>

                <p class="note-text">
                    *Pastikan nominal di aplikasi sama persis dengan total di atas.
                </p>

                <button class="btn-whatsapp-confirm" onclick="confirmOrderAutomatic()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    SAYA SUDAH TRANSFER
                </button>
            </div>
        </div>
    </div>
    <script>
        // --- 1. DATA MENU UTAMA ---
        // Perhatikan: Tidak ada kategori Add-ons di sini lagi.
        // supportsAddons: true menandakan item ini bisa dikustomisasi.
        const MENU_DATA = [
            {
                category: "DRINKS",
                items: [
                    { id: 1, name: "Americano", price: 10000, supportsAddons: true },
                    { id: 2, name: "Latte", price: 13000, supportsAddons: true },
                    { id: 3, name: "Oat Latte", price: 15000, supportsAddons: true },
                    { id: 4, name: "B&B Latte \u2605", price: 15000, desc: "Signature Drink", supportsAddons: true },
                    { id: 5, name: "B&B Oat Latte \u2605", price: 17000, desc: "Signature Drink", supportsAddons: true },
                    { id: 6, name: "Milktea \u2605", price: 16000, desc: "Best Seller", supportsAddons: true }
                ]
            },
            {
                category: "TREATS",
                items: [ // Treats biasanya tidak pakai extra shot/sugar, jadi supportsAddons false/undefined
                    { id: 7, name: "Sosis Bakar", price: 8000, isSoldOut: true},
                    { id: 8, name: "Ice Cream Cone", price: 7000 }
                ]
            }
        ];

        // --- 2. DATA ADD-ONS TERPISAH ---
        // Ini hanya muncul saat pop-up minuman muncul.
        const ADD_ONS_DATA = [
            { id: 'ao1', name: "Extra Shot", price: 3000 },
            { id: 'ao2', name: "Extra Sugar", price: 2000 },
            { id: 'ao3', name: "Less Sugar", price: 0 }
        ];
        function startCountdown() {
            // Tetapkan tanggal akhir: 19 November 2025, 23:59:59
            const countdownDate = new Date("November 28, 2025 23:59:59").getTime();

            const timerInterval = setInterval(function() {
                const now = new Date().getTime();
                const distance = countdownDate - now;

                // Perhitungan waktu
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                // Tampilkan di HTML
                document.getElementById("days").innerText = days;
                document.getElementById("hours").innerText = hours;
                document.getElementById("minutes").innerText = minutes;
                document.getElementById("seconds").innerText = seconds;

                // Jika waktu habis
                if (distance < 0) {
                    clearInterval(timerInterval);
                    
                    // Default: SELALU KUNCI WEBSITE (Setiap refresh akan masuk sini)
                    document.getElementById("countdown-banner").innerHTML = "PRE-ORDER SUDAH DITUTUP";
                    
                    // 1. Tampilkan Overlay
                    // Cek dulu biar overlay gak dobel kalau interval jalan
                    if (!document.querySelector('.po-closed-overlay')) {
                        const overlay = document.createElement('div');
                        overlay.className = 'po-closed-overlay';
                        overlay.innerHTML = `
                            <div class="overlay-content">
                                <h2 onclick="secretAdminLogin()" style="cursor: default;">Pre-Order Telah Ditutup</h2>
                                <p>Terima kasih atas partisipasinya! Sampai jumpa di PO berikutnya.</p>
                                <a href="/leaderboard.html">Lihat Klasemen Akhir</a>
                            </div>
                        `;
                        document.body.appendChild(overlay);
                    }

                    // 2. Sembunyikan Tombol Keranjang
                    const cartButton = document.getElementById('floating-cart');
                    if (cartButton) cartButton.style.display = 'none';
                    
                    // 3. Matikan Tombol Beli
                    document.querySelectorAll('.btn-add').forEach(btn => btn.disabled = true);
                }
            }, 1000);
        }

        let cart = [];
        let currentCustomItem = null; // Menyimpan sementara item yang sedang dikustomisasi
        
        let lastUniqueCode = 0;

        // --- RENDER MENU ---
        // --- RENDER MENU (VERSI UPDATE SOLD OUT) ---
        function renderMenu() {
            const container = document.getElementById('menu-container');
            // Kosongkan container dulu biar tidak double kalau direfresh
            container.innerHTML = ''; 

            MENU_DATA.forEach(section => {
                const sectionEl = document.createElement('section');
                sectionEl.className = 'menu-section';
                sectionEl.innerHTML = `<div class="category-banner">${section.category}</div><div class="menu-grid" id="grid-${section.category}"></div>`;
                container.appendChild(sectionEl);

                const gridEl = sectionEl.querySelector(`#grid-${section.category}`);
                
                section.items.forEach(item => {
                    const displayPrice = (item.price / 1000) + "k";
                    
                    // --- LOGIKA BARU UNTUK SOLD OUT ---
                    let itemClass = "menu-item";
                    let btnState = "";
                    let btnText = "+";
                    let btnStyle = "";
                    let nameLabel = item.name;
                    let action = item.supportsAddons ? `openCustomModal(${item.id})` : `directAddToCart(${item.id})`;

                    // Jika statusnya SOLD OUT (Habis)
                    if (item.isSoldOut) {
                        itemClass += " sold-out";       // Tambah class CSS sold-out
                        btnState = "disabled";          // Matikan tombol
                        btnText = "X";                  // Ganti text tombol
                        btnStyle = "background-color: #555; cursor: not-allowed;"; 
                        nameLabel += ` <span style="color:#ff4d4d; font-size:0.8em; font-weight:bold;">(HABIS)</span>`;
                        action = ""; // Hapus fungsi klik
                    }

                    gridEl.innerHTML += `
                        <div class="${itemClass}">
                            <div class="item-info">
                                <div class="item-name">${nameLabel}</div>
                                ${item.desc ? `<div class="item-desc">${item.desc}</div>` : ''}
                            </div>
                            <div class="item-action">
                                <div class="item-price">${displayPrice}</div>
                                <button class="btn-add" ${btnState} style="${btnStyle}" onclick="${action}">${btnText}</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- MODAL & CUSTOMIZATION LOGIC ---
        function toggleModal(modalId) {
            document.getElementById(modalId).classList.toggle('active');
        }

        function openCustomModal(itemId) {
            // Cari data produk
            for (const section of MENU_DATA) {
                const found = section.items.find(i => i.id === itemId);
                if (found) {
                    currentCustomItem = { ...found, selectedAddons: [] };
                    break;
                }
            }

            // Render isi modal
            document.getElementById('custom-item-name').innerText = currentCustomItem.name;
            const addonForm = document.getElementById('addon-form');
            addonForm.innerHTML = '<p style="margin-bottom:10px; opacity:0.8">Pilih tambahan (opsional):</p>';
            
            ADD_ONS_DATA.forEach(addon => {
                addonForm.innerHTML += `
                    <label class="addon-option">
                        <span>
                            <input type="checkbox" data-id="${addon.id}" data-price="${addon.price}" data-name="${addon.name}" onchange="updateCustomTotal()">
                            ${addon.name}
                        </span>
                        <span>+${addon.price.toLocaleString('id-ID')}</span>
                    </label>
                `;
            });

            updateCustomTotal();
            toggleModal('custom-modal');

            // Set action tombol konfirmasi
            document.getElementById('btn-confirm-add').onclick = () => confirmAddToCart();
        }

        function updateCustomTotal() {
            const checkboxes = document.querySelectorAll('#addon-form input[type="checkbox"]:checked');
            let addonTotal = 0;
            currentCustomItem.selectedAddons = []; // Reset pilihan sementara

            checkboxes.forEach(box => {
                addonTotal += parseInt(box.dataset.price);
                currentCustomItem.selectedAddons.push({
                    id: box.dataset.id,
                    name: box.dataset.name,
                    price: parseInt(box.dataset.price)
                });
            });

            const total = currentCustomItem.price + addonTotal;
            document.getElementById('custom-item-total').innerText = 'Rp ' + total.toLocaleString('id-ID');
        }

        // --- CART LOGIC ---
        // 1. Tambah langsung (untuk item tanpa add-ons, misal Treats)
        function directAddToCart(itemId) {
             for (const section of MENU_DATA) {
                const found = section.items.find(i => i.id === itemId);
                if (found) {
                    addItemToCartInternal(found, []);
                    break;
                }
            }
        }

        // 2. Konfirmasi tambah dari modal (untuk Drinks)
        function confirmAddToCart() {
            addItemToCartInternal(currentCustomItem, currentCustomItem.selectedAddons);
            toggleModal('custom-modal');
        }

        // Internal helper untuk memasukkan ke array cart
        function addItemToCartInternal(product, addOns) {
            // Kita butuh ID unik untuk setiap item di keranjang karena kombinasinya bisa banyak.
            // Contoh: Americano polos & Americano + Extra Sugar adalah 2 item berbeda di cart.
            const internalId = Date.now() + Math.random().toString(36).substr(2, 9);
            
            // Hitung harga total per item ini (Base + Addons)
            const addonsTotal = addOns.reduce((sum, ao) => sum + ao.price, 0);
            const finalPrice = product.price + addonsTotal;

            cart.push({
                internalId: internalId,
                productId: product.id,
                name: product.name,
                basePrice: product.price,
                addOns: addOns,
                finalPrice: finalPrice,
                qty: 1
            });

            updateCartUI();
            // Efek getar tombol floating
            const floatCart = document.getElementById('floating-cart');
            floatCart.style.transform = 'scale(1.1)';
            setTimeout(() => floatCart.style.transform = 'scale(1)', 200);
        }

        function updateCartQty(internalId, change) {
            const itemIndex = cart.findIndex(item => item.internalId === internalId);
            if (itemIndex > -1) {
                cart[itemIndex].qty += change;
                if (cart[itemIndex].qty <= 0) cart.splice(itemIndex, 1);
                updateCartUI();
            }
        }

        function updateCartUI() {
            const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cart-count').innerText = totalQty;

            const cartContainer = document.getElementById('cart-items-container');
            if (cart.length === 0) {
                cartContainer.innerHTML = '<p style="opacity: 0.5; text-align: center; margin-top: 50px;">Keranjang kosong.</p>';
                document.getElementById('cart-total').innerText = 'Rp 0';
                return;
            }

            cartContainer.innerHTML = '';
            let grandTotal = 0;

            cart.forEach(item => {
                grandTotal += (item.finalPrice * item.qty);
                
                // Format list add-ons untuk ditampilkan di keranjang
                let addonsHTML = '';
                if (item.addOns.length > 0) {
                    addonsHTML = '<small>+ ' + item.addOns.map(ao => ao.name).join(', ') + '</small>';
                }

                cartContainer.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-item-details">
                            <strong>${item.name}</strong>
                            ${addonsHTML}
                            <div>@ Rp ${item.finalPrice.toLocaleString('id-ID')}</div>
                        </div>
                        <div class="cart-item-actions">
                            <button class="btn-qty" onclick="updateCartQty('${item.internalId}', -1)">-</button>
                            <span>${item.qty}</span>
                            <button class="btn-qty" onclick="updateCartQty('${item.internalId}', 1)">+</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('cart-total').innerText = 'Rp ' + grandTotal.toLocaleString('id-ID');
        }

        // --- GANTI FUNGSI checkoutWA LAMA DENGAN 2 FUNGSI INI ---
        async function startPaymentProcess() {
            if (cart.length === 0) return alert("Keranjang kosong!");
            
            // --- VALIDASI INPUT ---
            const name = document.getElementById('cust-name').value.trim();
            const cls = document.getElementById('cust-class').value;
            const phone = document.getElementById('cust-phone').value.trim();
            if (!name || !cls || !phone) return alert("Mohon lengkapi semua data diri.");
            if (name.length <= 3) return alert("Nama harus lebih dari 3 huruf.");
            if (!/^\d+$/.test(phone) || phone.length < 10) return alert("Nomor HP tidak valid (min 10 angka).");
            if (cls === "") return alert("Silakan pilih Kelas.");

            // --- HITUNG TOTAL ---
            let baseTotal = cart.reduce((sum, item) => sum + (item.finalPrice * item.qty), 0);
            lastUniqueCode = Math.floor(Math.random() * (99 - 10 + 1)) + 10; // Kode unik 2 digit (10-99)
            let finalTransferAmount = baseTotal + lastUniqueCode;

            // --- TAMPILKAN LOADING ---
            // Tampilkan modal pembayaran dulu dengan status loading
            document.getElementById('payment-total').innerText = 'Rp ' + finalTransferAmount.toLocaleString('id-ID');
            document.getElementById('qris-area').innerHTML = '<p style="opacity: 0.7;">‚è≥ Sedang membuat QRIS...</p>';
            toggleModal('cart-modal');
            setTimeout(() => toggleModal('payment-modal'), 300);

            try {
                // --- PANGGIL BACKEND VERCEL ---
                // Ini adalah jembatan ke server Anda
                const response = await fetch('/api/generate-qris', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: finalTransferAmount })
                });

                if (!response.ok) throw new Error("Gagal menghubungi server pembuatan QRIS");

                const data = await response.json();

                if (data.qr_string) {
                    // --- SUKSES DAPAT DATA DARI BACKEND ---
                    // Render ulang QR Code dengan string dari server
                    document.getElementById('qris-area').innerHTML = ""; 
                    new QRCode(document.getElementById('qris-area'), {
                        text: data.qr_string,
                        width: 200,
                        height: 200,
                        correctLevel : QRCode.CorrectLevel.L
                    });
                } else {
                    throw new Error("Data QRIS tidak valid dari server");
                }

            } catch (error) {
                console.error("QRIS Error:", error);
                alert("Maaf, gagal memuat QRIS. Silakan coba lagi atau hubungi admin.");
                toggleModal('payment-modal'); // Tutup modal jika gagal
            }
        }

        // --- GANTI FUNGSI confirmPaymentWA LAMA DENGAN INI ---
        async function confirmOrderAutomatic() {
            // 1. Ambil Data Input
            const name = document.getElementById('cust-name').value.trim();
            const cls = document.getElementById('cust-class').value;
            const phone = document.getElementById('cust-phone').value.trim();
            
            // 2. Hitung Ulang Total
            let baseTotal = cart.reduce((sum, item) => sum + (item.finalPrice * item.qty), 0);
            let finalTotal = baseTotal + lastUniqueCode;
            // Buat ID Order unik, misal: ORD-174829
            let orderId = "ORD-" + Date.now().toString().slice(-6);

            // 3. Format Item untuk Laporan
            let itemsReport = cart.map(i => `- ${i.name} (${i.qty}x) ${i.addOns.length ? '[' + i.addOns.map(a=>a.name).join(',') + ']' : ''}`).join('\n');

            // 4. Ubah Tombol jadi Loading
            const btn = document.querySelector('.btn-whatsapp-confirm');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Sedang Memproses...';
            btn.disabled = true;

            try {
                // 5. Panggil Backend Vercel (Pastikan Anda sudah buat file api/process-order.js)
                const response = await fetch('/api/process-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId, name, classInfo: cls, phone,
                        total: baseTotal, uniqueCode: lastUniqueCode, finalTotal,
                        items: itemsReport
                    })
                });

                if (!response.ok) throw new Error('Gagal memproses order di server.');

                // --- JIKA SUKSES ---
                // Tutup modal pembayaran
                toggleModal('payment-modal');
                
                // Tampilkan notifikasi sukses ke pembeli
                alert(`‚úÖ PESANAN BERHASIL DITERIMA!\n\nOrder ID: ${orderId}\nStatus: Menunggu Verifikasi Admin.\n\nTerima kasih sudah memesan! Mohon tunggu admin memverifikasi pembayaran Anda.`);
                
                // Reset Keranjang & Form
                cart = [];
                updateCartUI();
                document.getElementById('cust-name').value = '';
                document.getElementById('cust-phone').value = '';
                document.getElementById('cust-class').value = '';

            } catch (error) {
                // --- JIKA GAGAL ---
                console.error("Error:", error);
                alert("‚ö†Ô∏è Terjadi kesalahan saat menghubungi server.\n\nSilakan screenshot halaman ini dan kirim manual ke Admin via WhatsApp.");
            } finally {
                // Kembalikan tombol seperti semula (jika error, user bisa coba klik lagi)
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        // --- AKHIR FUNGSI PENGGANTI ---

        document.addEventListener('DOMContentLoaded', () => {
            renderMenu();
            startCountdown(); // <-- TAMBAHKAN BARIS INI
        });
        let secretClicks = 0;

        async function secretAdminLogin() {
            secretClicks++;
            console.log("Klik: " + secretClicks);

            if (secretClicks === 2) {
                const passwordInput = prompt("Masukkan Password Admin:");
                if (!passwordInput) { secretClicks = 0; return; }

                const btn = document.querySelector('.overlay-content h2');
                const oriText = btn.innerText;
                btn.innerText = "‚è≥ Membuka Akses...";

                try {
                    // Cek password ke backend
                    const response = await fetch('/api/check-admin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: passwordInput })
                    });
                    const data = await response.json();

                    if (data.success) {
                        // --- JIKA PASSWORD BENAR ---
                        alert("Mode Admin Aktif! (Akses akan hilang jika di-refresh)");

                        // 1. Hapus Overlay Pengganggu
                        const overlay = document.querySelector('.po-closed-overlay');
                        if (overlay) overlay.remove();

                        // 2. Ubah Banner Atas
                        const banner = document.getElementById("countdown-banner");
                        banner.innerHTML = "‚ö†Ô∏è MODE ADMIN SEMENTARA";
                        banner.style.background = "#ff4d4d";

                        // 3. Munculkan Tombol Keranjang Lagi
                        const cartButton = document.getElementById('floating-cart');
                        if (cartButton) cartButton.style.display = 'flex';

                        // 4. Hidupkan Tombol Beli
                        document.querySelectorAll('.btn-add').forEach(btn => {
                            // Hanya hidupkan yg tidak sold out dari sananya
                            if(!btn.innerText.includes("HABIS")) btn.disabled = false;
                        });

                    } else {
                        alert("Password Salah!");
                        btn.innerText = oriText;
                    }
                    // Reset klik agar bisa coba lagi
                    secretClicks = 0; 

                } catch (e) {
                    console.error(e);
                    alert("Gagal menghubungi server.");
                    secretClicks = 0;
                    btn.innerText = oriText;
                }
            }
        }

        // Fitur Logout (Opsional, buat jaga-jaga kalau mau tes jadi user biasa lagi)
        // Ketik 'logoutAdmin()' di Console browser untuk keluar.
        function logoutAdmin() {
            localStorage.removeItem("adminAccess");
            location.reload();
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</body>
</html>