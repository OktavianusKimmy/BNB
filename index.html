<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brew & Beats - Symphony of Talent</title>
    <link href="https://fonts.googleapis.com/css2?family=Limelight&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #19194d;
            --accent-color: #a4a4e0;
            --text-color: #ffffff;
            --card-bg: #24245e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
            line-height: 1.5;
            padding-bottom: 80px;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        /* --- Header --- */
        header {
            text-align: center; margin-bottom: 40px; border: 2px solid var(--accent-color); padding: 20px; position: relative;
        }
        header::before, header::after {
            content: ''; position: absolute; width: 10px; height: 10px; border: 2px solid var(--accent-color); background: var(--bg-color);
        }
        header::before { top: -6px; left: -6px; }
        header::after { bottom: -6px; right: -6px; }
        h1 { font-family: 'Limelight', cursive; font-size: 2.5rem; color: var(--accent-color); }
        h2 { font-family: 'Limelight', cursive; font-size: 1.8rem; }

        /* --- Menu & Grid --- */
        .menu-section { margin-bottom: 40px; }
        .category-banner {
            background-color: #3a3a7a; color: #fff; font-weight: 800; font-size: 1.5rem; padding: 5px 20px;
            clip-path: polygon(0 0, 95% 0, 100% 50%, 95% 100%, 0 100%); display: inline-block; margin-bottom: 15px;
        }
        .menu-grid { display: grid; gap: 15px; }
        .menu-item {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed var(--accent-color);
        }
        .item-info { flex-grow: 1; }
        .item-name { font-weight: 600; font-size: 1.1rem; }
        .item-desc { font-size: 0.8rem; opacity: 0.7; }
        .item-action { display: flex; align-items: center; gap: 15px; min-width: 120px; justify-content: flex-end; }
        .item-price { font-family: 'Limelight', cursive; font-size: 1.2rem; color: var(--accent-color); }
        .btn-add {
            background-color: var(--accent-color); color: var(--bg-color); border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; transition: transform 0.2s;
        }
        .btn-add:hover { transform: scale(1.1); background-color: #fff; }

        /* --- Floating Cart & Modal --- */
        #floating-cart {
            position: fixed; bottom: 20px; right: 20px; background-color: var(--accent-color); color: var(--bg-color); padding: 15px 25px; border-radius: 30px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 99; display: flex; align-items: center; gap: 10px;
        }
        .cart-count { background: var(--bg-color); color: var(--accent-color); padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; }

        /* --- Universal Modal Styles (Cart & Custom) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; visibility: hidden;
        }
        .modal.active { visibility: visible; }
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); opacity: 0; transition: opacity 0.3s;
        }
        .modal.active .modal-overlay { opacity: 1; }
        
        /* Cart Specific Modal (Slide from right) */
        #cart-modal .modal-content {
            position: absolute; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100vh; background-color: #24245e; transition: right 0.3s ease; display: flex; flex-direction: column;
        }
        #cart-modal.active .modal-content { right: 0; }

        /* Custom Add-on Specific Modal (Popup in center) */
        #custom-modal .modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); 
            width: 90%; max-width: 350px; background-color: #24245e; padding: 25px; border-radius: 15px; 
            border: 2px solid var(--accent-color); opacity: 0; transition: all 0.3s ease;
        }
        #custom-modal.active .modal-content { transform: translate(-50%, -50%) scale(1); opacity: 1; }

        /* --- Modal Inner Elements --- */
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .modal-header h3 { font-family: 'Limelight', cursive; color: var(--accent-color); }
        .close-btn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        
        .cart-items { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #333370; }
        .cart-item-details small { display: block; opacity: 0.7; }
        .cart-item-actions { display: flex; gap: 10px; align-items: center; }
        .btn-qty { background: var(--bg-color); color: var(--accent-color); border: 1px solid var(--accent-color); width: 25px; height: 25px; border-radius: 50%; cursor: pointer; }
        
        .modal-footer { padding: 20px; background: #1a1a4a; border-top: 2px solid var(--accent-color); }
        .total-row { display: flex; justify-content: space-between; font-size: 1.2rem; margin-bottom: 15px; font-weight: bold; }
        .btn-primary { width: 100%; padding: 12px; background-color: var(--accent-color); color: var(--bg-color); border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-whatsapp { background-color: #25D366; color: white; }

        /* --- Custom Add-on Form --- */
        .addon-group { margin-bottom: 20px; }
        .addon-option {
            display: flex; justify-content: space-between; padding: 10px; background: #1a1a4a; margin-bottom: 8px; border-radius: 8px; cursor: pointer;
        }
        .addon-option input { margin-right: 10px; }

        footer { text-align: center; margin-top: 50px; padding: 20px; border-top: 1px solid var(--accent-color); opacity: 0.7; font-size: 0.9rem; }
        /* --- NEW CSS: Form Data Diri --- */
        .customer-form { background: #15153a; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .form-group { margin-bottom: 10px; }
        .form-label { display: block; font-size: 0.9rem; margin-bottom: 5px; opacity: 0.8; }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--accent-color); background: #0f0f2e; color: #fff; border-radius: 5px; font-family: inherit; }
        .form-input:focus { outline: none; border-color: #fff; }
        .form-select {
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--accent-color); 
            background: #0f0f2e; 
            color: #fff; 
            border-radius: 5px; 
            font-family: inherit;
            /* Baris ini untuk memunculkan panah dropdown kustom */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        .form-select:focus { 
            outline: none; 
            border-color: #fff; 
        }
        .form-select option {
            background-color: #1a1a4a;
            color: #fff;
        }
        /* Tambahan untuk memastikan modal pembayaran selalu paling atas */
        /* --- CSS TAMBAHAN UNTUK MODAL PEMBAYARAN --- */
        /* Pastikan modal pembayaran di atas segalanya */
        #payment-modal {
            z-index: 200;
            display: flex; /* Menggunakan flex untuk pemusatan yang lebih baik */
            align-items: center;
            justify-content: center;
        }

        /* Gaya Konten Modal Pembayaran */
        #payment-modal .modal-content {
            position: relative; /* Relatif terhadap flex container */
            top: auto; left: auto; right: auto; bottom: auto; /* Reset posisi absolute jika ada */
            transform: none; /* Reset transform jika ada */
            width: 90%;
            max-width: 380px;
            background-color: var(--card-bg); /* Gunakan variabel warna tema */
            border-radius: 20px;
            border: 2px solid var(--accent-color);
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            overflow: hidden; /* Agar sudut border-radius tidak terpotong */
            animation: slideUp 0.4s ease forwards; /* Animasi masuk */
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Header Modal */
        #payment-modal .modal-header {
            background-color: #1a1a4a;
            padding: 15px 20px;
            border-bottom: 2px solid var(--accent-color);
        }
        #payment-modal .modal-header h3 {
            font-family: 'Limelight', cursive;
            color: var(--accent-color);
            margin: 0;
            font-size: 1.4rem;
        }

        /* Body Modal */
        #payment-modal .modal-body {
            padding: 25px 20px;
            text-align: center;
            max-height: 70vh; /* Batasi tinggi agar tidak melebihi layar */
            overflow-y: auto; /* Scroll jika konten terlalu panjang */
        }

        /* Area QRIS */
        #qris-area {
            background-color: #fff;
            padding: 15px;
            border-radius: 15px;
            margin: 20px auto;
            width: fit-content; /* Lebar menyesuaikan konten */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #qris-area img {
            display: block; /* Menghilangkan gap di bawah gambar */
        }

        /* Kotak Total */
        .total-box {
            background-color: #15153a;
            padding: 15px;
            border-radius: 12px;
            border: 2px dashed var(--accent-color);
            margin: 20px 0;
        }
        #payment-total {
            font-family: 'Limelight', cursive;
            color: #25D366; /* Warna hijau untuk uang */
            font-size: 2.2rem;
            display: block;
            margin-top: 5px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Tombol Konfirmasi WA */
        .btn-whatsapp-confirm {
            background: linear-gradient(45deg, #25D366, #128C7E);
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }
        .btn-whatsapp-confirm:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.5);
        }
        
        /* --- Akhir CSS Tambahan --- */
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>SYMPHONY OF TALENT</h1>
            <h2>Brew & Beats</h2>
        </header>
        <main id="menu-container"></main>
        <footer>Pre-order: Nov 12-19, 2025</footer>
    </div>

    <div id="floating-cart" onclick="toggleModal('cart-modal')">
        <span>üõí Keranjang</span><span class="cart-count" id="cart-count">0</span>
    </div>

    <div id="custom-modal" class="modal">
        <div class="modal-overlay" onclick="toggleModal('custom-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="custom-item-name">Kustomisasi</h3>
                <button class="close-btn" onclick="toggleModal('custom-modal')">√ó</button>
            </div>
            <div id="addon-form">
                </div>
            <div class="total-row" style="font-size: 1rem; margin-top: 20px;">
                <span>Total Item:</span>
                <span id="custom-item-total">Rp 0</span>
            </div>
            <button class="btn-primary" id="btn-confirm-add">Tambahkan ke Keranjang</button>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div class="modal-overlay" onclick="toggleModal('cart-modal')"></div>
        <div class="modal-content">
            <div class="modal-header" style="padding: 20px; background: #1a1a4a;">
                <h3>Pesanan Anda</h3>
                <button class="close-btn" onclick="toggleModal('cart-modal')">√ó</button>
            </div>
            <div class="cart-items" id="cart-items-container"></div>
            <div class="modal-footer">
                <div class="customer-form">
                    <div class="form-group">
                        <label class="form-label">Nama Pemesan *</label>
                        <input type="text" id="cust-name" class="form-input" placeholder="Contoh: Budi Santoso">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kelas *</label>
                        <select id="cust-class" class="form-select">
                            <option value="">-- Pilih Kelas --</option>
                            <option value="PPBP 7">PPBP 7</option>
                            <option value="PPBP 8">PPBP 8</option>
                            <option value="PPBP 9">PPBP 9</option>
                            <option value="PPBP 10">PPBP 10</option>
                            <option value="PPTI 20">PPTI 20</option>
                            <option value="PPTI 21">PPTI 21</option>
                            <option value="PPTI 22">PPTI 22</option>
                            <option value="PPTI 23">PPTI 23</option>
                            <option value="PPTI 24">PPTI 24</option>
                            <option value="PPTI 25">PPTI 25</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nomor HP (WhatsApp) *</label>
                        <input type="tel" id="cust-phone" class="form-input" placeholder="Contoh: 08123456789">
                    </div>
                </div>
                <div class="total-row">
                    <span>Total:</span><span id="cart-total">Rp 0</span>
                </div>
                <button class="btn-primary btn-whatsapp" onclick="startPaymentProcess()">Lanjut Pembayaran QRIS</button>
            </div>
        </div>
    </div>
    <div id="payment-modal" class="modal">
        <div class="modal-overlay"></div> 

        <div class="modal-content">
            <div class="modal-header">
                <h3>Pembayaran QRIS</h3>
                <button class="close-btn" onclick="toggleModal('payment-modal')">√ó</button>
            </div>
            
            <div class="modal-body">
                <p style="opacity: 0.9; font-size: 0.95rem;">
                    Scan QRIS ini. Nominal akan <strong>otomatis muncul</strong> di aplikasi pembayaran Anda.
                </p>
                
                <div id="qris-area"></div>

                <div class="total-box">
                    <span style="display: block; font-size: 0.9rem; opacity: 0.7; margin-bottom: 5px;">Total yang harus dibayar:</span>
                    <span id="payment-total">Rp 0</span>
                </div>

                <p style="font-size: 0.85rem; opacity: 0.6; margin-bottom: 25px;">
                    Pastikan nominal di aplikasi sama persis dengan total di atas sebelum membayar.
                </p>

                <button class="btn-whatsapp-confirm" onclick="confirmOrderAutomatic()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    SAYA SUDAH TRANSFER
                </button>
            </div>
        </div>
    </div>
    <script>
        // --- 1. DATA MENU UTAMA ---
        // Perhatikan: Tidak ada kategori Add-ons di sini lagi.
        // supportsAddons: true menandakan item ini bisa dikustomisasi.
        const MENU_DATA = [
            {
                category: "DRINKS",
                items: [
                    { id: 1, name: "Americano", price: 0, supportsAddons: true },
                    { id: 2, name: "Latte", price: 13000, supportsAddons: true },
                    { id: 3, name: "Oat Latte", price: 15000, supportsAddons: true },
                    { id: 4, name: "B&B Latte \u2605", price: 15000, desc: "Signature Drink", supportsAddons: true },
                    { id: 5, name: "B&B Oat Latte \u2605", price: 17000, desc: "Signature Drink", supportsAddons: true },
                    { id: 6, name: "Milktea \u2605", price: 16000, desc: "Best Seller", supportsAddons: true }
                ]
            },
            {
                category: "TREATS",
                items: [ // Treats biasanya tidak pakai extra shot/sugar, jadi supportsAddons false/undefined
                    { id: 7, name: "Sosis Bakar", price: 8000 },
                    { id: 8, name: "Ice Cream Cone", price: 7000 }
                ]
            }
        ];

        // --- 2. DATA ADD-ONS TERPISAH ---
        // Ini hanya muncul saat pop-up minuman muncul.
        const ADD_ONS_DATA = [
            { id: 'ao1', name: "Extra Shot", price: 3000 },
            { id: 'ao2', name: "Extra Sugar", price: 2000 },
            { id: 'ao3', name: "Less Sugar", price: 0 }
        ];

        let cart = [];
        let currentCustomItem = null; // Menyimpan sementara item yang sedang dikustomisasi
        
        let lastUniqueCode = 0;

        // --- RENDER MENU ---
        function renderMenu() {
            const container = document.getElementById('menu-container');
            MENU_DATA.forEach(section => {
                const sectionEl = document.createElement('section');
                sectionEl.className = 'menu-section';
                sectionEl.innerHTML = `<div class="category-banner">${section.category}</div><div class="menu-grid" id="grid-${section.category}"></div>`;
                container.appendChild(sectionEl);

                const gridEl = sectionEl.querySelector(`#grid-${section.category}`);
                section.items.forEach(item => {
                    const displayPrice = (item.price / 1000) + "k";
                    // Cek apakah item ini butuh modal kustomisasi atau langsung masuk keranjang
                    const clickAction = item.supportsAddons ? `openCustomModal(${item.id})` : `directAddToCart(${item.id})`;
                    
                    gridEl.innerHTML += `
                        <div class="menu-item">
                            <div class="item-info">
                                <div class="item-name">${item.name}</div>
                                ${item.desc ? `<div class="item-desc">${item.desc}</div>` : ''}
                            </div>
                            <div class="item-action">
                                <div class="item-price">${displayPrice}</div>
                                <button class="btn-add" onclick="${clickAction}">+</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- MODAL & CUSTOMIZATION LOGIC ---
        function toggleModal(modalId) {
            document.getElementById(modalId).classList.toggle('active');
        }

        function openCustomModal(itemId) {
            // Cari data produk
            for (const section of MENU_DATA) {
                const found = section.items.find(i => i.id === itemId);
                if (found) {
                    currentCustomItem = { ...found, selectedAddons: [] };
                    break;
                }
            }

            // Render isi modal
            document.getElementById('custom-item-name').innerText = currentCustomItem.name;
            const addonForm = document.getElementById('addon-form');
            addonForm.innerHTML = '<p style="margin-bottom:10px; opacity:0.8">Pilih tambahan (opsional):</p>';
            
            ADD_ONS_DATA.forEach(addon => {
                addonForm.innerHTML += `
                    <label class="addon-option">
                        <span>
                            <input type="checkbox" data-id="${addon.id}" data-price="${addon.price}" data-name="${addon.name}" onchange="updateCustomTotal()">
                            ${addon.name}
                        </span>
                        <span>+${addon.price.toLocaleString('id-ID')}</span>
                    </label>
                `;
            });

            updateCustomTotal();
            toggleModal('custom-modal');

            // Set action tombol konfirmasi
            document.getElementById('btn-confirm-add').onclick = () => confirmAddToCart();
        }

        function updateCustomTotal() {
            const checkboxes = document.querySelectorAll('#addon-form input[type="checkbox"]:checked');
            let addonTotal = 0;
            currentCustomItem.selectedAddons = []; // Reset pilihan sementara

            checkboxes.forEach(box => {
                addonTotal += parseInt(box.dataset.price);
                currentCustomItem.selectedAddons.push({
                    id: box.dataset.id,
                    name: box.dataset.name,
                    price: parseInt(box.dataset.price)
                });
            });

            const total = currentCustomItem.price + addonTotal;
            document.getElementById('custom-item-total').innerText = 'Rp ' + total.toLocaleString('id-ID');
        }

        // --- CART LOGIC ---
        // 1. Tambah langsung (untuk item tanpa add-ons, misal Treats)
        function directAddToCart(itemId) {
             for (const section of MENU_DATA) {
                const found = section.items.find(i => i.id === itemId);
                if (found) {
                    addItemToCartInternal(found, []);
                    break;
                }
            }
        }

        // 2. Konfirmasi tambah dari modal (untuk Drinks)
        function confirmAddToCart() {
            addItemToCartInternal(currentCustomItem, currentCustomItem.selectedAddons);
            toggleModal('custom-modal');
        }

        // Internal helper untuk memasukkan ke array cart
        function addItemToCartInternal(product, addOns) {
            // Kita butuh ID unik untuk setiap item di keranjang karena kombinasinya bisa banyak.
            // Contoh: Americano polos & Americano + Extra Sugar adalah 2 item berbeda di cart.
            const internalId = Date.now() + Math.random().toString(36).substr(2, 9);
            
            // Hitung harga total per item ini (Base + Addons)
            const addonsTotal = addOns.reduce((sum, ao) => sum + ao.price, 0);
            const finalPrice = product.price + addonsTotal;

            cart.push({
                internalId: internalId,
                productId: product.id,
                name: product.name,
                basePrice: product.price,
                addOns: addOns,
                finalPrice: finalPrice,
                qty: 1
            });

            updateCartUI();
            // Efek getar tombol floating
            const floatCart = document.getElementById('floating-cart');
            floatCart.style.transform = 'scale(1.1)';
            setTimeout(() => floatCart.style.transform = 'scale(1)', 200);
        }

        function updateCartQty(internalId, change) {
            const itemIndex = cart.findIndex(item => item.internalId === internalId);
            if (itemIndex > -1) {
                cart[itemIndex].qty += change;
                if (cart[itemIndex].qty <= 0) cart.splice(itemIndex, 1);
                updateCartUI();
            }
        }

        function updateCartUI() {
            const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cart-count').innerText = totalQty;

            const cartContainer = document.getElementById('cart-items-container');
            if (cart.length === 0) {
                cartContainer.innerHTML = '<p style="opacity: 0.5; text-align: center; margin-top: 50px;">Keranjang kosong.</p>';
                document.getElementById('cart-total').innerText = 'Rp 0';
                return;
            }

            cartContainer.innerHTML = '';
            let grandTotal = 0;

            cart.forEach(item => {
                grandTotal += (item.finalPrice * item.qty);
                
                // Format list add-ons untuk ditampilkan di keranjang
                let addonsHTML = '';
                if (item.addOns.length > 0) {
                    addonsHTML = '<small>+ ' + item.addOns.map(ao => ao.name).join(', ') + '</small>';
                }

                cartContainer.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-item-details">
                            <strong>${item.name}</strong>
                            ${addonsHTML}
                            <div>@ Rp ${item.finalPrice.toLocaleString('id-ID')}</div>
                        </div>
                        <div class="cart-item-actions">
                            <button class="btn-qty" onclick="updateCartQty('${item.internalId}', -1)">-</button>
                            <span>${item.qty}</span>
                            <button class="btn-qty" onclick="updateCartQty('${item.internalId}', 1)">+</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('cart-total').innerText = 'Rp ' + grandTotal.toLocaleString('id-ID');
        }

        // --- GANTI FUNGSI checkoutWA LAMA DENGAN 2 FUNGSI INI ---
        async function startPaymentProcess() {
            if (cart.length === 0) return alert("Keranjang kosong!");
            
            // --- VALIDASI INPUT ---
            const name = document.getElementById('cust-name').value.trim();
            const cls = document.getElementById('cust-class').value;
            const phone = document.getElementById('cust-phone').value.trim();
            if (!name || !cls || !phone) return alert("Mohon lengkapi semua data diri.");
            if (name.length <= 5) return alert("Nama harus lebih dari 5 huruf.");
            if (!/^\d+$/.test(phone) || phone.length < 10) return alert("Nomor HP tidak valid (min 10 angka).");
            if (cls === "") return alert("Silakan pilih Kelas.");

            // --- HITUNG TOTAL ---
            let baseTotal = cart.reduce((sum, item) => sum + (item.finalPrice * item.qty), 0);
            lastUniqueCode = 1 //Math.floor(Math.random() * (99 - 10 + 1)) + 10; // Kode unik 2 digit (10-99)
            let finalTransferAmount = baseTotal + lastUniqueCode;

            // --- TAMPILKAN LOADING ---
            // Tampilkan modal pembayaran dulu dengan status loading
            document.getElementById('payment-total').innerText = 'Rp ' + finalTransferAmount.toLocaleString('id-ID');
            document.getElementById('qris-area').innerHTML = '<p style="opacity: 0.7;">‚è≥ Sedang membuat QRIS...</p>';
            toggleModal('cart-modal');
            setTimeout(() => toggleModal('payment-modal'), 300);

            try {
                // --- PANGGIL BACKEND VERCEL ---
                // Ini adalah jembatan ke server Anda
                const response = await fetch('/api/generate-qris', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: finalTransferAmount })
                });

                if (!response.ok) throw new Error("Gagal menghubungi server pembuatan QRIS");

                const data = await response.json();

                if (data.qr_string) {
                    // --- SUKSES DAPAT DATA DARI BACKEND ---
                    // Render ulang QR Code dengan string dari server
                    document.getElementById('qris-area').innerHTML = ""; 
                    new QRCode(document.getElementById('qris-area'), {
                        text: data.qr_string,
                        width: 200,
                        height: 200,
                        correctLevel : QRCode.CorrectLevel.L
                    });
                } else {
                    throw new Error("Data QRIS tidak valid dari server");
                }

            } catch (error) {
                console.error("QRIS Error:", error);
                alert("Maaf, gagal memuat QRIS. Silakan coba lagi atau hubungi admin.");
                toggleModal('payment-modal'); // Tutup modal jika gagal
            }
        }

        // --- GANTI FUNGSI confirmPaymentWA LAMA DENGAN INI ---
        async function confirmOrderAutomatic() {
            // 1. Ambil Data Input
            const name = document.getElementById('cust-name').value.trim();
            const cls = document.getElementById('cust-class').value;
            const phone = document.getElementById('cust-phone').value.trim();
            
            // 2. Hitung Ulang Total
            let baseTotal = cart.reduce((sum, item) => sum + (item.finalPrice * item.qty), 0);
            let finalTotal = baseTotal + lastUniqueCode;
            // Buat ID Order unik, misal: ORD-174829
            let orderId = "ORD-" + Date.now().toString().slice(-6);

            // 3. Format Item untuk Laporan
            let itemsReport = cart.map(i => `- ${i.name} (${i.qty}x) ${i.addOns.length ? '[' + i.addOns.map(a=>a.name).join(',') + ']' : ''}`).join('\n');

            // 4. Ubah Tombol jadi Loading
            const btn = document.querySelector('.btn-whatsapp-confirm');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Sedang Memproses...';
            btn.disabled = true;

            try {
                // 5. Panggil Backend Vercel (Pastikan Anda sudah buat file api/process-order.js)
                const response = await fetch('/api/process-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId, name, classInfo: cls, phone,
                        total: baseTotal, uniqueCode: lastUniqueCode, finalTotal,
                        items: itemsReport
                    })
                });

                if (!response.ok) throw new Error('Gagal memproses order di server.');

                // --- JIKA SUKSES ---
                // Tutup modal pembayaran
                toggleModal('payment-modal');
                
                // Tampilkan notifikasi sukses ke pembeli
                alert(`‚úÖ PESANAN BERHASIL DITERIMA!\n\nOrder ID: ${orderId}\nStatus: Menunggu Verifikasi Admin.\n\nTerima kasih sudah memesan! Mohon tunggu admin memverifikasi pembayaran Anda.`);
                
                // Reset Keranjang & Form
                cart = [];
                updateCartUI();
                document.getElementById('cust-name').value = '';
                document.getElementById('cust-phone').value = '';
                document.getElementById('cust-class').value = '';

            } catch (error) {
                // --- JIKA GAGAL ---
                console.error("Error:", error);
                alert("‚ö†Ô∏è Terjadi kesalahan saat menghubungi server.\n\nSilakan screenshot halaman ini dan kirim manual ke Admin via WhatsApp.");
            } finally {
                // Kembalikan tombol seperti semula (jika error, user bisa coba klik lagi)
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        // --- AKHIR FUNGSI PENGGANTI ---

        document.addEventListener('DOMContentLoaded', renderMenu);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</body>
</html>