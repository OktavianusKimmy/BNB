<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Pesanan - Brew & Beats</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #19194d; color: white; font-family: 'Montserrat', sans-serif; padding: 20px; }
        h1 { text-align: center; color: #a4a4e0; margin-bottom: 20px; }
        
        /* Tombol Kembali */
        .btn-back { 
            display: inline-block; text-decoration: none; color: white; background: #333; 
            padding: 8px 15px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9rem; border: none; cursor: pointer;
        }
        .btn-back:hover { background: #555; }

        /* Controls */
        .controls-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .filter-select, .search-box { padding: 12px; border-radius: 8px; border: 1px solid #a4a4e0; background: #24245e; color: white; font-family: inherit; outline: none; }
        .filter-select { cursor: pointer; min-width: 150px; }
        .search-box { flex-grow: 1; max-width: 400px; }

        /* Summary Cards */
        .summary-box { display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; }
        .card { background: #24245e; padding: 15px 25px; border-radius: 10px; border: 1px solid #a4a4e0; text-align: center; min-width: 150px; }
        .card h3 { margin: 0; font-size: 1.8rem; color: #a4a4e0; }
        .card p { margin: 0; opacity: 0.8; font-size: 0.9rem; }

        /* TABLE STYLE */
        .table-container { overflow-x: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        table { width: 100%; border-collapse: collapse; background: #24245e; }
        
        th { background-color: #a4a4e0; color: #19194d; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; padding: 15px; text-align: left; }
        td { padding: 15px; text-align: left; border-bottom: 1px solid #444480; vertical-align: top; } 
        tr:hover { background-color: #2f2f7a; }

        /* List Styling */
        .item-list div { margin-bottom: 8px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 4px; }
        .item-list div:last-child { border-bottom: none; }
        .addon-list div { margin-bottom: 8px; color: #FFC107; font-size: 0.9rem; padding-bottom: 4px; height: 21px; }

        /* --- STYLE BARU: TOMBOL STATUS --- */
        .status-container {
            display: flex; gap: 10px; align-items: center;
        }

        .btn-status {
            padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; 
            border: none; width: 100px; transition: 0.3s;
            font-size: 0.85rem;
        }

        /* Status Belum (Abu-abu) */
        .status-pending {
            background-color: #666; color: #ccc;
        }
        .status-pending:hover { background-color: #777; }

        /* Status Selesai (Hijau) */
        .status-done {
            background-color: #4ade80; color: #000;
        }
        
        /* Tombol Hapus Kecil */
        .btn-trash {
            background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5;
        }
        .btn-trash:hover { opacity: 1; transform: scale(1.1); }

    </style>
</head>
<body>

    <button class="btn-back" onclick="window.location.href='admin.html'">‚¨Ö Kembali ke Dashboard</button>

    <h1>DATA PESANAN MASUK</h1>

    <div class="summary-box">
        <div class="card">
            <h3 id="total-orders">0</h3>
            <p>Jml Pesanan</p>
        </div>
        <div class="card">
            <h3 id="total-income">Rp 0</h3>
            <p>Total Pemasukan</p>
        </div>
    </div>

    <div class="controls-container">
        <select id="filter-class" class="filter-select" onchange="applyFilter()">
            <option value="ALL">üìÇ Semua Kelas</option>
        </select>
        <input type="text" id="search-input" class="search-box" placeholder="üîç Cari Nama, Menu, atau No HP..." onkeyup="applyFilter()">
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Waktu</th>
                    <th>Nama & Kelas</th>
                    <th>No. HP</th>
                    <th width="30%">Item Pesanan</th>
                    <th width="20%">Add-ons</th>
                    <th>Total</th>
                    <th>Verifikasi</th> </tr>
            </thead>
            <tbody id="order-table-body">
                <tr><td colspan="7" style="text-align:center;">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        // --- 0. CEK LOGIN ---
        if (sessionStorage.getItem('isAdmin') !== 'true') {
            alert("‚ö†Ô∏è Akses Ditolak! Login dulu.");
            window.location.href = 'index.html';
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Tambahkan 'update' di sini
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCU82AX-l80wXvxb_S4eToRQ0cRt8RXZa4",
            authDomain: "brew-and-beats-5fbf2.firebaseapp.com",
            databaseURL: "https://brew-and-beats-5fbf2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "brew-and-beats-5fbf2",
            storageBucket: "brew-and-beats-5fbf2.firebasestorage.app",
            messagingSenderId: "243138026852",
            appId: "1:243138026852:web:73d5e7cdb446949033ee71",
            measurementId: "G-S3ZX1F1FTP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.allOrdersData = []; 
        const ordersRef = ref(db, 'orders');
        const tableBody = document.getElementById('order-table-body');
        const totalOrdersEl = document.getElementById('total-orders');
        const totalIncomeEl = document.getElementById('total-income');
        const classFilterEl = document.getElementById('filter-class');

        // --- 1. AMBIL DATA ---
        onValue(ordersRef, (snapshot) => {
            const data = snapshot.val();
            window.allOrdersData = []; 

            if (data) {
                window.allOrdersData = Object.entries(data).map(([key, value]) => {
                    return { id: key, ...value };
                }).sort((a, b) => a.timestamp - b.timestamp);
            }

            populateClassDropdown();
            applyFilter();
        });

        // --- 2. DROPDOWN KELAS ---
        function populateClassDropdown() {
            const uniqueClasses = [...new Set(window.allOrdersData.map(item => item.class || "Lainnya"))].sort();
            const currentSelection = classFilterEl.value;
            classFilterEl.innerHTML = '<option value="ALL">üìÇ Semua Kelas</option>';
            uniqueClasses.forEach(cls => {
                if(cls) classFilterEl.innerHTML += `<option value="${cls}">${cls}</option>`;
            });
            if (uniqueClasses.includes(currentSelection)) classFilterEl.value = currentSelection;
        }

        // --- 3. FILTER LOGIC ---
        window.applyFilter = function() {
            const filterValue = document.getElementById('filter-class').value;
            const searchValue = document.getElementById('search-input').value.toLowerCase();

            let filteredData = window.allOrdersData.filter(order => {
                const classMatch = (filterValue === "ALL") || (order.class === filterValue);
                const searchString = (order.customer + " " + order.items + " " + order.phone).toLowerCase();
                const searchMatch = searchString.includes(searchValue);
                return classMatch && searchMatch;
            });

            renderTable(filteredData);
        }

        // --- 4. RENDER TABEL ---
        function renderTable(dataArray) {
            tableBody.innerHTML = '';
            let count = 0;
            let income = 0;

            if (dataArray.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 30px; opacity: 0.7;">Tidak ada data.</td></tr>';
                totalOrdersEl.innerText = '0';
                totalIncomeEl.innerText = 'Rp 0';
                return;
            }

            dataArray.forEach(order => {
                count++;
                let cleanPrice = parseInt(order.total.replace(/[^0-9]/g, '')) || 0;
                income += cleanPrice;

                let dateObj = new Date(order.timestamp);
                let timeStr = dateObj.toLocaleDateString('id-ID') + '<br><small>' + dateObj.toLocaleTimeString('id-ID') + '</small>';

                // Parsing Item & Addons
                let itemsHtml = '';
                let addonsHtml = '';

                if (order.orderDetails) {
                    try {
                        const cart = JSON.parse(order.orderDetails);
                        cart.forEach(item => {
                            itemsHtml += `<div>‚Ä¢ ${item.name} <b>(${item.qty}x)</b></div>`;
                            if (item.addOns && item.addOns.length > 0) {
                                const names = item.addOns.map(a => a.name).join(', ');
                                addonsHtml += `<div>+ ${names}</div>`;
                            } else {
                                addonsHtml += `<div>-</div>`;
                            }
                        });
                    } catch (e) {
                        itemsHtml = order.items;
                        addonsHtml = '-';
                    }
                } else {
                    itemsHtml = order.items.split(', ').join('<br>‚Ä¢ ');
                    if(itemsHtml) itemsHtml = '‚Ä¢ ' + itemsHtml;
                    addonsHtml = '<span style="opacity:0.5">-</span>';
                }

                // --- LOGIKA TOMBOL STATUS ---
                // Cek apakah status di database sudah "true" (Done) atau belum
                const isDone = order.isDone === true; 
                
                // Tentukan Warna & Teks
                const btnClass = isDone ? 'status-done' : 'status-pending';
                const btnText = isDone ? 'DONE ‚úÖ' : 'NOT DONE';
                
                // Tentukan status kebalikannya untuk fungsi toggle (kalau diklik)
                const nextStatus = !isDone; 

                let row = `
                    <tr>
                        <td>${timeStr}</td>
                        <td>
                            <strong>${order.customer}</strong><br>
                            <span style="color:#a4a4e0; font-size:0.85rem;">${order.class || '-'}</span>
                        </td>
                        <td>
                            <a href="https://wa.me/${order.phone}" target="_blank" style="color:#4ade80; text-decoration:none;">
                                ${order.phone} ‚Üó
                            </a>
                        </td>
                        <td class="item-list">${itemsHtml}</td>
                        <td class="addon-list">${addonsHtml}</td>
                        <td style="font-weight:bold; color:#a4a4e0;">${order.total}</td>
                        
                        <td>
                            <div class="status-container">
                                <button class="btn-status ${btnClass}" onclick="toggleStatus('${order.id}', ${nextStatus})">
                                    ${btnText}
                                </button>
                                <button class="btn-trash" onclick="deleteOrder('${order.id}')" title="Hapus Permanen">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            totalOrdersEl.innerText = count;
            totalIncomeEl.innerText = 'Rp ' + income.toLocaleString('id-ID');
        }

        // --- 5. FUNGSI TOGGLE STATUS (HIJAU/ABU) ---
        window.toggleStatus = function(orderId, newStatus) {
            // Update status 'isDone' di Firebase
            // Tidak menghapus data, cuma ganti status
            update(ref(db, 'orders/' + orderId), {
                isDone: newStatus
            });
        }

        // --- 6. FUNGSI HAPUS (DELETE PERMANEN) ---
        window.deleteOrder = function(orderId) {
            if (confirm('Yakin ingin MENGHAPUS data ini secara permanen?')) {
                remove(ref(db, 'orders/' + orderId));
            }
        }
    </script>
</body>
</html>