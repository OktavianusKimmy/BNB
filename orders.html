<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Pesanan - Brew & Beats</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #19194d; color: white; font-family: 'Montserrat', sans-serif; padding: 20px; }
        h1 { text-align: center; color: #a4a4e0; margin-bottom: 20px; }
        
        .btn-back { display: inline-block; text-decoration: none; color: white; background: #333; padding: 8px 15px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9rem; border: none; cursor: pointer; }
        .btn-back:hover { background: #555; }

        /* Controls */
        .controls-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .filter-select, .search-box { padding: 12px; border-radius: 8px; border: 1px solid #a4a4e0; background: #24245e; color: white; font-family: inherit; outline: none; }
        .filter-select { cursor: pointer; min-width: 150px; }
        .search-box { flex-grow: 1; max-width: 400px; }

        /* Summary Cards */
        .summary-box { display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; }
        .card { background: #24245e; padding: 15px 25px; border-radius: 10px; border: 1px solid #a4a4e0; text-align: center; min-width: 150px; }
        .card h3 { margin: 0; font-size: 1.8rem; color: #a4a4e0; }
        .card p { margin: 0; opacity: 0.8; font-size: 0.9rem; }

        /* TABLE STYLE */
        .table-container { overflow-x: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        table { width: 100%; border-collapse: collapse; background: #24245e; }
        
        th { background-color: #a4a4e0; color: #19194d; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; padding: 15px; text-align: left; }
        td { padding: 15px; text-align: left; border-bottom: 1px solid #444480; vertical-align: top; } 
        tr:hover { background-color: #2f2f7a; }

        /* --- PERBAIKAN LIST (ALIGNMENT) --- */
        .line-item {
            display: flex;
            align-items: center;
            min-height: 24px; /* Tinggi minimum agar item & addon sejajar */
            margin-bottom: 5px;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            padding-bottom: 2px;
        }
        .line-item:last-child { border-bottom: none; }
        
        .addon-text { color: #FFC107; font-size: 0.85rem; }
        .empty-addon { opacity: 0.3; }

        /* STATUS & ACTION */
        .status-container { display: flex; gap: 10px; align-items: center; }
        .btn-status { padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; border: none; width: 100px; transition: 0.3s; font-size: 0.85rem; }
        .status-pending { background-color: #666; color: #ccc; }
        .status-pending:hover { background-color: #777; }
        .status-done { background-color: #4ade80; color: #000; }
        .btn-trash { background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5; }
        .btn-trash:hover { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>

    <button class="btn-back" onclick="window.location.href='admin.html'">‚¨Ö Kembali ke Dashboard</button>

    <h1>DATA PESANAN MASUK</h1>

    <div class="summary-box">
        <div class="card">
            <h3 id="total-orders">0</h3>
            <p>Jml Pesanan</p>
        </div>
        <div class="card">
            <h3 id="total-income">Rp 0</h3>
            <p>Total Pemasukan</p>
        </div>
    </div>

    <div class="controls-container">
        <select id="filter-class" class="filter-select" onchange="applyFilter()">
            <option value="ALL">üìÇ Semua Kelas</option>
        </select>
        <input type="text" id="search-input" class="search-box" placeholder="üîç Cari Nama, Menu, atau No HP..." onkeyup="applyFilter()">
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Waktu</th>
                    <th>Nama & Kelas</th>
                    <th>No. HP</th>
                    <th width="30%">Item Pesanan</th>
                    <th width="20%">Add-ons</th>
                    <th>Total</th>
                    <th>Verifikasi</th> </tr>
            </thead>
            <tbody id="order-table-body">
                <tr><td colspan="7" style="text-align:center;">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        // --- 0. CEK LOGIN ---
        if (sessionStorage.getItem('isAdmin') !== 'true') {
            alert("‚ö†Ô∏è Akses Ditolak! Login dulu.");
            window.location.href = 'index.html';
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCU82AX-l80wXvxb_S4eToRQ0cRt8RXZa4",
            authDomain: "brew-and-beats-5fbf2.firebaseapp.com",
            databaseURL: "https://brew-and-beats-5fbf2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "brew-and-beats-5fbf2",
            storageBucket: "brew-and-beats-5fbf2.firebasestorage.app",
            messagingSenderId: "243138026852",
            appId: "1:243138026852:web:73d5e7cdb446949033ee71",
            measurementId: "G-S3ZX1F1FTP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const auth = getAuth(app); // Inisialisasi Auth

        // --- CEK LOGIN FIREBASE (Agar Database Mengizinkan Hapus) ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // Kalau Firebase tidak mendeteksi login, tendang keluar
                alert("‚ö†Ô∏è Sesi habis atau belum login. Silakan login ulang.");
                window.location.href = 'index.html';
            }
            // Kalau user ada, biarkan script jalan (listener data di bawah ini)
        });

        window.allOrdersData = []; 
        const ordersRef = ref(db, 'orders');
        const tableBody = document.getElementById('order-table-body');
        const totalOrdersEl = document.getElementById('total-orders');
        const totalIncomeEl = document.getElementById('total-income');
        const classFilterEl = document.getElementById('filter-class');

        // --- 1. AMBIL DATA ---
        onValue(ordersRef, (snapshot) => {
            const data = snapshot.val();
            window.allOrdersData = []; 

            if (data) {
                window.allOrdersData = Object.entries(data).map(([key, value]) => {
                    return { id: key, ...value };
                }).sort((a, b) => b.timestamp - a.timestamp); // Urutkan dari yang terbaru (descending)
            }

            populateClassDropdown();
            applyFilter();
        });

        // --- 2. DROPDOWN KELAS ---
        function populateClassDropdown() {
            const uniqueClasses = [...new Set(window.allOrdersData.map(item => item.class || "Lainnya"))].sort();
            const currentSelection = classFilterEl.value;
            classFilterEl.innerHTML = '<option value="ALL">üìÇ Semua Kelas</option>';
            uniqueClasses.forEach(cls => {
                if(cls) classFilterEl.innerHTML += `<option value="${cls}">${cls}</option>`;
            });
            if (uniqueClasses.includes(currentSelection)) classFilterEl.value = currentSelection;
        }

        // --- 3. FILTER LOGIC ---
        window.applyFilter = function() {
            const filterValue = document.getElementById('filter-class').value;
            const searchValue = document.getElementById('search-input').value.toLowerCase();

            let filteredData = window.allOrdersData.filter(order => {
                const classMatch = (filterValue === "ALL") || (order.class === filterValue);
                // Tambahkan pengecekan null safety biar gak error kalau data kosong
                const custName = order.customer || "";
                const custItems = order.items || "";
                const custPhone = order.phone || "";
                
                const searchString = (custName + " " + custItems + " " + custPhone).toLowerCase();
                const searchMatch = searchString.includes(searchValue);
                return classMatch && searchMatch;
            });

            renderTable(filteredData);
        }

        // --- 4. RENDER TABEL (SUDAH DIPERBAIKI PARSINGNYA) ---
        function renderTable(dataArray) {
            tableBody.innerHTML = '';
            let count = 0;
            let income = 0;

            if (dataArray.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 30px; opacity: 0.7;">Tidak ada data.</td></tr>';
                totalOrdersEl.innerText = '0';
                totalIncomeEl.innerText = 'Rp 0';
                return;
            }

            dataArray.forEach(order => {
                count++;
                let cleanPrice = parseInt((order.total || "0").replace(/[^0-9]/g, '')) || 0;
                income += cleanPrice;

                let dateObj = new Date(order.timestamp);
                let timeStr = dateObj.toLocaleDateString('id-ID') + '<br><small>' + dateObj.toLocaleTimeString('id-ID') + '</small>';

                // --- LOGIKA PARSING ITEM & ADDONS YANG BENAR ---
                let itemsHtml = '';
                let addonsHtml = '';

                let cart = [];

                // Cek apakah orderDetails ada?
                if (order.orderDetails) {
                    // JIKA SUDAH ARRAY/OBJECT (Format Baru yang Benar)
                    if (typeof order.orderDetails === 'object') {
                        cart = Object.values(order.orderDetails); // Ubah ke array jaga-jaga kalau bentuknya object index
                    } 
                    // JIKA MASIH STRING (Format JSON String)
                    else if (typeof order.orderDetails === 'string') {
                        try {
                            cart = JSON.parse(order.orderDetails);
                        } catch (e) {
                            console.error("Gagal parse JSON string:", e);
                            cart = []; // Gagal parse, kosongkan
                        }
                    }
                }

                // --- RENDER DARI CART (DATA BARU) ---
                if (cart.length > 0) {
                    cart.forEach(item => {
                        // Kolom Kiri: Item
                        itemsHtml += `<div class="line-item">‚Ä¢ ${item.name} <b>(${item.qty}x)</b></div>`;
                        
                        // Kolom Kanan: Add-on
                        if (item.addOns && item.addOns.length > 0) {
                            const names = item.addOns.map(a => a.name).join(', ');
                            addonsHtml += `<div class="line-item addon-text">+ ${names}</div>`;
                        } else {
                            addonsHtml += `<div class="line-item empty-addon">-</div>`;
                        }
                    });
                } 
                // --- FALLBACK: DATA LAMA (Hanya String dipisah koma) ---
                else {
                    const rawItems = order.items || "";
                    // Pisahkan berdasarkan koma yang diikuti spasi, atau koma saja
                    const itemsArray = rawItems.split(/,\s*/); 
                    
                    itemsArray.forEach(itm => {
                        if(itm.trim() !== "") {
                            itemsHtml += `<div class="line-item">‚Ä¢ ${itm}</div>`;
                            addonsHtml += `<div class="line-item empty-addon">-</div>`; 
                        }
                    });
                }

                // --- STATUS ---
                const isDone = order.isDone === true; 
                const btnClass = isDone ? 'status-done' : 'status-pending';
                const btnText = isDone ? 'DONE ‚úÖ' : 'NOT DONE';
                const nextStatus = !isDone; 

                let row = `
                    <tr>
                        <td>${timeStr}</td>
                        <td>
                            <strong>${order.customer}</strong><br>
                            <span style="color:#a4a4e0; font-size:0.85rem;">${order.class || '-'}</span>
                        </td>
                        <td>
                            <a href="https://wa.me/62${order.phone}" target="_blank" style="color:#4ade80; text-decoration:none;">
                                ${order.phone} ‚Üó
                            </a>
                        </td>
                        <td style="vertical-align:top;">${itemsHtml}</td>
                        <td style="vertical-align:top;">${addonsHtml}</td>
                        <td style="font-weight:bold; color:#a4a4e0;">${order.total}</td>
                        
                        <td>
                            <div class="status-container">
                                <button class="btn-status ${btnClass}" onclick="toggleStatus('${order.id}', ${nextStatus})">
                                    ${btnText}
                                </button>
                                <button class="btn-trash" onclick="deleteOrder('${order.id}')" title="Hapus Permanen">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            totalOrdersEl.innerText = count;
            totalIncomeEl.innerText = 'Rp ' + income.toLocaleString('id-ID');
        }

        // --- 5. FUNGSI TOGGLE STATUS ---
        window.toggleStatus = function(orderId, newStatus) {
            update(ref(db, 'orders/' + orderId), {
                isDone: newStatus
            });
        }

        // --- 6. FUNGSI HAPUS ---
        window.deleteOrder = function(orderId) {
            if (confirm('Yakin ingin MENGHAPUS data ini secara permanen?')) {
                remove(ref(db, 'orders/' + orderId))
                .then(() => {
                    // Berhasil, data akan hilang otomatis karena onValue realtime
                    console.log("Data dihapus");
                })
                .catch((error) => {
                    // Kalau masih gagal, biasanya karena permission
                    alert("Gagal menghapus! Pastikan Anda login sebagai Admin.\nError: " + error.message);
                });
            }
        }
    </script>
</body>
</html>